<!DOCTYPE html>
<html lang="zh-HK"> <!-- è¨­ç‚ºç¹é«”ä¸­æ–‡ -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nose.h.k | sensory discovery</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon (Embedded) -->
    <link rel="icon" href="public/icon.png" type="image/png">

    <style>
        /* â–¼â–¼â–¼ å…¨å±€æ¨£å¼èˆ‡å‹•ç•« â–¼â–¼â–¼ */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f8fa; /* ç¨å¾®èª¿æ•´èƒŒæ™¯è‰²ï¼Œä½¿å…¶æ›´æŸ”å’Œ */
            padding-bottom: 80px; 
            -webkit-font-smoothing: antialiased; /* å­—é«”æ¸²æŸ“å„ªåŒ– */
            -moz-osx-font-smoothing: grayscale;
        }

        /* æ›´ç²¾ç·»çš„æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #adb5bd; }

        /* å…¨å±€éæ¸¡æ•ˆæœ */
        button, a, select, input, .result-card, .filter-btn, .sense-btn, .date-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* â–²â–²â–² çµæŸå…¨å±€æ¨£å¼ â–²â–²â–² */

        /* â–¼â–¼â–¼ Header å’Œ Nav Bar æ¨£å¼ â–¼â–¼â–¼ */
        .header-nav-style {
            background-color: rgba(255, 255, 255, 0.7); /* åŠé€æ˜ç»ç’ƒæ•ˆæœ */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .bottom-nav-style {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }
        /* â–²â–²â–² çµæŸ Header/Nav æ¨£å¼ â–²â–²â–² */

        /* â–¼â–¼â–¼ ç¯©é¸å™¨å’ŒæŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */
        .filter-btn {
            position: relative;
            color: #6b7280;
            font-weight: 500;
        }
        .filter-btn.active {
            color: #111827;
        }
        .filter-btn::after {
            content: '';
            position: absolute;
            bottom: -1px; /* è²¼åˆçˆ¶å®¹å™¨çš„ border */
            left: 50%;
            width: 0;
            height: 2px;
            background-color: #111827;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        .filter-btn.active::after {
            width: 50%;
        }

        .sense-btn {
            border: 1px solid #e5e7eb;
        }
        .sense-btn:hover {
            transform: translateY(-2px);
            border-color: #d1d5db;
        }
        .sense-btn.active {
            background-color: #374151;
            color: #ffffff;
            border-color: #374151;
        }
        
        /* æ—¥æœŸæ»¾å‹•æ¢ */
        #date-scroller { -ms-overflow-style: none; scrollbar-width: none; }
        #date-scroller::-webkit-scrollbar { display: none; }

        .date-btn {
            display: inline-block;
            white-space: nowrap;
            padding: 8px 16px;
            border-radius: 20px;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            color: #374151;
            font-weight: 500;
            font-size: 0.875rem;
            margin-right: 8px;
            cursor: pointer;
        }
        .date-btn:hover { 
            background-color: #f3f4f6;
            transform: translateY(-2px);
        }
        .date-btn.active {
            background-color: #212529;
            color: #ffffff;
            border-color: #212529;
            box-shadow: 0 4px 15px rgba(33, 37, 41, 0.1);
        }
        /* â–²â–²â–² çµæŸç¯©é¸å™¨æ¨£å¼ â–²â–²â–² */

        /* â–¼â–¼â–¼ çµæœå¡ç‰‡æ¨£å¼ â–¼â–¼â–¼ */
        .result-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.03), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
        }
        .result-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
        }
        /* â–²â–²â–² çµæŸå¡ç‰‡æ¨£å¼ â–²â–²â–² */

        /* â–¼â–¼â–¼ Modal å½ˆå‡ºè¦–çª—æ¨£å¼ â–¼â–¼â–¼ */
        #modal-backdrop {
            transition: opacity 0.3s ease;
        }
        #modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; }
        .modal-enter .modal-content-transform { transform: scale(0.95) translateY(10px); }
        .modal-enter-active .modal-content-transform { transform: scale(1) translateY(0); }
        /* â–²â–²â–² çµæŸ Modal æ¨£å¼ â–²â–²â–² */

        /* â–¼â–¼â–¼ åº•éƒ¨ Tab Bar æ¨£å¼ â–¼â–¼â–¼ */
        .tab-btn {
            color: #9ca3af; /* æœªé¸ä¸­æ™‚æ›´æ·ºè‰² */
        }
        .tab-btn.active {
            color: #111827;
        }
        .tab-btn:hover {
            color: #374151;
        }
        .tab-btn svg {
            transition: transform 0.2s ease;
        }
        .tab-btn:hover svg {
            transform: scale(1.1);
        }
        /* â–²â–²â–² çµæŸ Tab Bar æ¨£å¼ â–²â–²â–² */

        /* â–¼â–¼â–¼ æ–°å¢çš„ fancy æŒ‰éˆ•æ¨£å¼ â–¼â–¼â–¼ */
        .fancy-btn {
            background-color: #1f2937;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(31, 41, 55, 0.1);
        }
        .fancy-btn:hover {
            background-color: #111827;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(31, 41, 55, 0.15);
        }
        .add-to-trip-btn {
            transition: all 0.2s ease;
        }
        .add-to-trip-btn:hover {
            transform: scale(1.1);
            background-color: #e5e7eb;
        }
        .add-to-trip-btn.active-animation svg {
            animation: pop 0.5s ease;
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(15deg); }
            100% { transform: scale(1); }
        }
        /* â–²â–²â–² çµæŸ fancy æŒ‰éˆ•æ¨£å¼ â–²â–²â–² */
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="header-nav-style sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <img src="public/icon.png" alt="logo" class="h-8 w-8">
                    <div>
                        <h1 class="text-lg font-bold tracking-tight">nose.h.k</h1>
                        <p class="text-xs text-gray-500">Sensory Discovery</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-sm font-medium flex-shrink-0">
                    <a href="https://forms.gle/Fz9KQkVYynCBQgfm7" target="_blank" class="py-2 px-4 rounded-lg hover:bg-gray-100/80">
                        <span class="sm:hidden">ç™»è¨˜</span>
                        <span class="hidden sm:inline">å°åº—/æ´»å‹•ç™»è¨˜</span>
                    </a>
                    <div id="auth-container" class="flex items-center gap-2 text-sm font-medium">
                        <!-- Auth UI will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div id="page-container">
        <!-- Explore Page -->
        <main id="explore-page" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <section id="filters" class="bg-white p-6 rounded-2xl shadow-lg shadow-gray-500/5 mb-8 border border-gray-200/50">
                <h2 class="text-xl font-bold mb-1 tracking-tight">Discover by senses â€”</h2>
                <p class="text-gray-500 mb-5">Pick one or more senses and explore Events & Local Shops curated for you.</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <div id="senses-container" class="flex flex-wrap gap-2 items-center"></div>
                    <div class="flex-grow flex flex-col sm:flex-row gap-3 mt-2 sm:mt-0">
                        <select id="district-select" class="w-full sm:w-40 p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-gray-400 focus:border-gray-400 outline-none"></select>
                        <input type="text" id="search-input" placeholder="æœå°‹æ´»å‹•æˆ–å°åº—..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400 outline-none">
                    </div>
                </div>
            </section>
            
            <section id="results-container">
                <div class="mb-4">
                    <div class="flex items-center gap-2 text-sm font-medium border-b border-gray-200">
                        <button data-filter="events" class="filter-btn active py-3 px-5">æ´»å‹•</button>
                        <button data-filter="places" class="filter-btn py-3 px-5">æœ¬åœ°å°åº—</button>
                    </div>
                </div>

                <div id="date-scroller" class="mb-6 -mt-2 pb-2 overflow-x-auto whitespace-nowrap">
                    <!-- Date buttons will be populated by JS -->
                </div>

                <p id="results-count" class="text-sm text-gray-500 mb-4"></p>
                
                <div id="loader" class="text-center py-10"><p class="text-gray-500">æ­£åœ¨åŠ è¼‰é«”é©—...</p></div>
                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="no-results" class="hidden text-center py-16">
                    <p class="text-lg text-gray-600">æ‰¾ä¸åˆ°ä»»ä½•é«”é©—ã€‚</p>
                    <p class="text-gray-500">è«‹å˜—è©¦èª¿æ•´ä½ çš„ç¯©é¸æ¢ä»¶ã€‚</p>
                </div>
            </section>
        </main>
        
        <!-- Planner Page -->
        <main id="planner-page" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Content populated by JS based on login state -->
        </main>
    </div>

    <!-- Bottom Tab Bar -->
    <nav class="bottom-nav-style fixed bottom-0 left-0 right-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-around">
            <button data-page="explore-page" class="tab-btn active flex-1 flex flex-col items-center justify-center py-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M9.69 2.522a.75.75 0 01.62 0l6.25 2.5a.75.75 0 01.44 1.012l-2.5 6.25a.75.75 0 01-1.012.44l-6.25-2.5a.75.75 0 01-.44-1.012l2.5-6.25a.75.75 0 011.012-.44zM8.5 9.75a.75.75 0 00-1.06-1.06l-1.5 1.5a.75.75 0 001.06 1.06l1.5-1.5zm2.56-1.06a.75.75 0 011.06 0l1.5 1.5a.75.75 0 01-1.06 1.06l-1.5-1.5a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg>
                <span class="text-xs font-medium">æ¢ç´¢</span>
            </button>
            <button data-page="planner-page" class="tab-btn flex-1 flex flex-col items-center justify-center py-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path d="M5.5 16.5a1.5 1.5 0 01-1.5-1.5V5A1.5 1.5 0 015.5 3.5h9A1.5 1.5 0 0116 5v10a1.5 1.5 0 01-1.5 1.5h-9zM7 6a1 1 0 00-1 1v1a1 1 0 001 1h6a1 1 0 001-1V7a1 1 0 00-1-1H7z" /></svg>
                <span class="text-xs font-medium">æˆ‘çš„è¡Œç¨‹</span>
            </button>
        </div>
    </nav>
    
    <!-- Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 hidden z-30 modal-enter">
        <div id="modal-content" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl bg-white rounded-2xl shadow-xl p-4 sm:p-6 modal-content-transform"></div>
    </div>
    
    <!-- Firebase SDKs and Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, arrayUnion, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; 

    const firebaseConfig = {
        apiKey: "AIzaSyBHw_5ApaAa6N18ym4QnzJwmoxWRP3M4Ac",
        authDomain: "nostartnoendhk-11a6a.firebaseapp.com",
        projectId: "nostartnoendhk-11a6a",
        storageBucket: "nostartnoendhk-11a6a.appspot.com",
        messagingSenderId: "1394470229",
        appId: "1:1394470229:web:e20dd66a469aaaf429d3dc",
        measurementId: "G-733PSHDR5L"
    };
    
    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("âœ… Firebase initialized successfully.");
    } catch (e) {
        console.error("âŒ Firebase initialization error:", e);
        document.body.innerHTML = `<p style="color: red; padding: 20px;">Error initializing Firebase. Check console.</p>`;
    }

    const SENSES = ['Eye', 'Ear', 'Nose', 'Tongue', 'Body', 'Mind'];
    const SENSES_ZH = ['çœ¼', 'è€³', 'é¼»', 'èˆŒ', 'èº«', 'æ„'];

    let allPlaces = [];
    let allEvents = [];
    let userTrips = [];
    let currentFilter = 'events';
    let selectedDate = 'all';

    // DOM Elements
    const authContainer = document.getElementById('auth-container');
    const sensesContainer = document.getElementById('senses-container');
    const districtSelect = document.getElementById('district-select');
    const searchInput = document.getElementById('search-input');
    const resultsGrid = document.getElementById('results-grid');
    const loader = document.getElementById('loader');
    const noResults = document.getElementById('no-results');
    const resultsCount = document.getElementById('results-count');
    const resultFilterButtons = document.querySelectorAll('.filter-btn');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalContent = document.getElementById('modal-content');
    const tabButtons = document.querySelectorAll('.tab-btn[data-page]');
    const explorePage = document.getElementById('explore-page');
    const plannerPage = document.getElementById('planner-page');
    const dateScroller = document.getElementById('date-scroller');

    // --- Helper Functions ---
    // å®‰å…¨çš„æ—¥æœŸè§£æå™¨ï¼Œè™•ç†å„ç¨®å¯èƒ½çš„ Firestore æ—¥æœŸæ ¼å¼
    function parseFirestoreDate(dateField) {
        if (!dateField) return null;
        try {
            // å¦‚æœæ˜¯ Firestore Timestamp
            if (typeof dateField.toDate === 'function') {
                return dateField.toDate();
            }
            // å¦‚æœå·²ç¶“æ˜¯ Date ç‰©ä»¶
            if (dateField instanceof Date) {
                return dateField;
            }
            // å¦‚æœæ˜¯å­—ä¸²
            if (typeof dateField === 'string') {
                // å˜—è©¦æ¨™æº–è½‰æ›
                let d = new Date(dateField);
                if (!isNaN(d.getTime())) return d;
                // å˜—è©¦è™•ç† "YYYY-MM-DD" æ ¼å¼
                const parts = dateField.split('-');
                if (parts.length === 3) {
                    return new Date(parts[0], parts[1] - 1, parts[2]);
                }
            }
        } catch (e) {
            console.warn("Error parsing date:", dateField, e);
        }
        return null;
    }

    function stringToColor(str) {
        if (!str) return '#cccccc';
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        let color = '#';
        for (let i = 0; i < 3; i++) {
            let value = (hash >> (i * 8)) & 0xFF;
            color += ('00' + value.toString(16)).substr(-2);
        }
        return color;
    }

    // --- Main Logic ---
    function showPage(pageId) {
        explorePage.classList.add('hidden');
        plannerPage.classList.add('hidden');
        document.getElementById(pageId).classList.remove('hidden');
        tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId));
        if (pageId === 'planner-page' && auth) renderPlannerPage(auth.currentUser);
    }

    // --- Auth & Planner ---
    const provider = new GoogleAuthProvider();
    function handleSignIn() { signInWithPopup(auth, provider).catch(e => console.error("Sign in error:", e)); }
    function handleSignOut() { signOut(auth).catch(e => console.error("Sign out error:", e)); }

    if (auth) {
         onAuthStateChanged(auth, user => {
            renderAuthUI(user);
            renderPlannerPage(user);
            if (user && db) { 
                fetchUserTrips(user.uid);
            } else {
                userTrips = [];
                if (!plannerPage.classList.contains('hidden')) renderPlannerPage(null);
            }
         });
    }

    function renderAuthUI(user) {
        authContainer.innerHTML = user ? 
            `<img src="${user.photoURL}" alt="${user.displayName}" class="w-8 h-8 rounded-full"><button id="logout-btn" class="py-2 px-4 rounded-lg hover:bg-gray-100/80">ç™»å‡º</button>` : 
            `<button id="login-btn" class="fancy-btn py-2 px-4 rounded-lg">Google ç™»å…¥</button>`;
        if (user) document.getElementById('logout-btn').addEventListener('click', handleSignOut);
        else document.getElementById('login-btn').addEventListener('click', handleSignIn);
    }

    function renderPlannerPage(user) {
        if (!user) {
            plannerPage.innerHTML = `<div class="text-center py-16"><h2 class="text-2xl font-bold mb-2 tracking-tight">æˆ‘çš„è¡Œç¨‹</h2><p class="text-gray-600 mb-4">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹æˆ–å»ºç«‹ä½ çš„è¡Œç¨‹ã€‚</p><button id="planner-login-btn" class="fancy-btn py-2 px-4 rounded-lg">Google ç™»å…¥</button></div>`;
            document.getElementById('planner-login-btn')?.addEventListener('click', handleSignIn);
        } else {
            plannerPage.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold tracking-tight">æˆ‘çš„è¡Œç¨‹</h2><button id="new-trip-btn" class="fancy-btn py-2 px-4 rounded-lg">å»ºç«‹æ–°è¡Œç¨‹</button></div><div id="trips-container" class="space-y-6"></div>`;
            document.getElementById('new-trip-btn')?.addEventListener('click', createNewTrip);
            renderUserTrips();
        }
    }

    async function createNewTrip() {
        const user = auth?.currentUser;
        if (!user || !db) return;
        const tripName = prompt("è«‹è¼¸å…¥æ–°è¡Œç¨‹çš„åç¨±ï¼š", "æˆ‘çš„é¦™æ¸¯ä¹‹æ—…");
        if (tripName) await addDoc(collection(db, "trips"), { userId: user.uid, name: tripName, createdAt: Timestamp.now(), items: [] });
    }

    function fetchUserTrips(userId) {
        if (!db) return;
        onSnapshot(query(collection(db, "trips"), where("userId", "==", userId)), 
            (snapshot) => {
                userTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                userTrips.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                renderUserTrips();
            }, 
            (error) => console.error("Error fetching user trips: ", error)
        );
    }

    function renderUserTrips() {
        const container = document.getElementById('trips-container');
        if (!container) return; 
        container.innerHTML = userTrips.length === 0 ? 
            `<p class="text-gray-500 text-center">ä½ å°šæœªå»ºç«‹ä»»ä½•è¡Œç¨‹ã€‚</p>` : 
            userTrips.map(trip => `
                <div class="bg-white p-6 rounded-2xl shadow-lg shadow-gray-500/5 border border-gray-200/50">
                    <h3 class="text-xl font-bold mb-3 tracking-tight">${trip.name}</h3>
                    <div class="space-y-3">${trip.items.length > 0 ? trip.items.map(item => `
                        <div class="flex items-center justify-between p-3 bg-gray-50/80 rounded-lg">
                            <div><p class="font-semibold">${item.name || item.title}</p><p class="text-sm text-gray-500">${item.category}</p></div>
                            <a href="${item.url}" target="_blank" class="text-sm text-gray-600 hover:text-gray-900 font-medium">æŸ¥çœ‹</a>
                        </div>`).join('') : '<p class="text-sm text-gray-500">é€™å€‹è¡Œç¨‹ä¸­é‚„æ²’æœ‰é …ç›®ã€‚</p>'}
                    </div>
                </div>`).join('');
    }

    async function handleAddToTrip(item) {
        const user = auth?.currentUser;
        if (!user || !db) { alert("è«‹å…ˆç™»å…¥ï¼Œæ‰èƒ½å°‡é …ç›®æ–°å¢åˆ°è¡Œç¨‹ä¸­ã€‚"); return; }
        try {
            let tripId;
            if (userTrips.length === 0) {
                const ref = await addDoc(collection(db, "trips"), { userId: user.uid, name: "æˆ‘çš„é¦™æ¸¯ä¹‹æ—…", createdAt: Timestamp.now(), items: [] });
                tripId = ref.id;
            } else { tripId = userTrips[0].id; }
            
            const currentTrip = userTrips.find(t => t.id === tripId);
            const itemName = item.name || item.title;
            if (!currentTrip?.items.some(i => (i.id && i.id === item.id) || (i.name === itemName))) {
                await updateDoc(doc(db, "trips", tripId), { items: arrayUnion({ id: item.id || null, name: itemName, category: item.category || (item.title ? 'æ´»å‹•' : 'åœ°é»'), url: item.url }) });
                console.log("âœ… Item added to trip!");
            }
        } catch (e) { console.error("Error adding to trip:", e); }
    }

    // --- Data Fetching & Rendering ---
    function fetchData() {
        if (!db) return;
        console.log("ğŸ”„ Starting fetchData...");
        loader.style.display = 'block';
        
        const handleSnapshot = (snapshot, type) => {
            console.log(`ğŸ“¡ Received ${type} snapshot: ${snapshot.docs.length} docs`);
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (type === 'places') allPlaces = data;
            if (type === 'events') allEvents = data;
            populateDistricts();
            performSearch();
        };
        
        const handleError = (type, error) => {
            console.error(`âŒ Error fetching ${type}:`, error);
            loader.style.display = 'none';
            resultsGrid.innerHTML = `<p class="text-red-500 col-span-full text-center">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£ç·šã€‚</p>`;
        };

        try {
            onSnapshot(collection(db, "places"), (snap) => handleSnapshot(snap, 'places'), (err) => handleError('places', err));
            onSnapshot(collection(db, "events"), (snap) => handleSnapshot(snap, 'events'), (err) => handleError('events', err));
        } catch(e) {
            console.error("âŒ Error setting up listeners:", e);
        }
    }

    function populateSenses() {
        sensesContainer.innerHTML = SENSES.map((sense, i) => `<button data-sense="${sense}" class="sense-btn px-3 py-1.5 rounded-lg text-sm font-medium">${SENSES_ZH[i]}</button>`).join('');
        sensesContainer.addEventListener('click', e => { if (e.target.classList.contains('sense-btn')) { e.target.classList.toggle('active'); performSearch(); }});
    }

    function populateDistricts() {
        const current = districtSelect.value;
        const districts = [...new Set([...allPlaces.map(p => p.district), ...allEvents.map(e => e.district)])].filter(Boolean).sort();
        districtSelect.innerHTML = `<option value="all">æ‰€æœ‰åœ°å€</option>` + districts.map(d => `<option value="${d}">${d}</option>`).join('');
        districtSelect.value = current;
    }

    function populateDateScroller() {
        let html = `<button class="date-btn active" data-date="all">æ‰€æœ‰æ—¥å­</button>`;
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        for (let i = 0; i < 6; i++) {
            const d = new Date(); d.setDate(d.getDate() + i);
            html += `<button class="date-btn" data-date="${d.toISOString().split('T')[0]}">${d.getDate()} (${weekdays[d.getDay()]})</button>`;
        }
        dateScroller.innerHTML = html;
    }

    function performSearch() {
        // console.log("ğŸ” Performing search..."); // Debug log
        const selectedSenses = Array.from(sensesContainer.querySelectorAll('.sense-btn.active')).map(btn => btn.dataset.sense);
        const selectedDistrict = districtSelect.value;
        const searchQuery = searchInput.value.toLowerCase();
        const isEventMode = currentFilter === 'events';

        let results = isEventMode ? allEvents : allPlaces;

        const filtered = results.filter(item => {
            if (!(item.name || item.title)) return false;
            
            // 1. åŸºæœ¬ç¯©é¸
            const districtMatch = selectedDistrict === 'all' || item.district === selectedDistrict;
            const senses = item.senses || item.selected_senses || '';
            const sensesMatch = selectedSenses.length === 0 || selectedSenses.every(s => senses.includes(s));
            const searchMatch = searchQuery === '' || (item.name || item.title).toLowerCase().includes(searchQuery);

            if (!districtMatch || !sensesMatch || !searchMatch) return false;

            // 2. æ—¥æœŸç¯©é¸ (åƒ…é‡å°æ´»å‹•)
            if (isEventMode) {
                const today = new Date(); today.setHours(0,0,0,0);
                const eventEnd = parseFirestoreDate(item.end_date);
                
                // éæ¿¾æ‰å·²çµæŸçš„æ´»å‹•
                if (eventEnd && eventEnd < today) return false;

                // æŒ‡å®šæ—¥æœŸç¯©é¸
                if (selectedDate !== 'all') {
                    const filterDate = new Date(selectedDate); filterDate.setHours(0,0,0,0);
                    const eventStart = parseFirestoreDate(item.start_date);
                    // å¦‚æœç„¡æ³•è§£æé–‹å§‹æ—¥æœŸï¼Œå‰‡ä¸é¡¯ç¤º
                    if (!eventStart) return false; 

                    eventStart.setHours(0,0,0,0);
                    // å¦‚æœæ²’æœ‰çµæŸæ—¥æœŸï¼Œå‡è¨­å®ƒåªåœ¨é–‹å§‹æ—¥æœŸç•¶å¤©æœ‰æ•ˆ
                    const effectiveEnd = eventEnd ? eventEnd : new Date(eventStart);
                    effectiveEnd.setHours(23,59,59,999);

                    // æª¢æŸ¥ç¯©é¸æ—¥æœŸæ˜¯å¦åœ¨æ´»å‹•æœŸé–“å…§
                    if (!(filterDate >= eventStart && filterDate <= effectiveEnd)) return false;
                }
            }
            return true;
        });

        // æ’åº
        filtered.sort((a, b) => {
            if (isEventMode) {
                const dateA = parseFirestoreDate(a.start_date)?.getTime() || Infinity;
                const dateB = parseFirestoreDate(b.start_date)?.getTime() || Infinity;
                return dateA - dateB;
            } else {
                const dateA = parseFirestoreDate(a.created_at)?.getTime() || 0;
                const dateB = parseFirestoreDate(b.created_at)?.getTime() || 0;
                return dateB - dateA;
            }
        });

        renderResults(filtered);
    }

    function renderResults(results) {
        resultsGrid.innerHTML = '';
        resultsCount.textContent = `é¡¯ç¤º ${results.length} å€‹çµæœ`;
        loader.style.display = 'none';
        noResults.style.display = results.length === 0 ? 'block' : 'none';

        results.forEach((item, index) => {
            const isEvent = 'title' in item;
            const name = item.name || item.title;
            const senses = (item.senses || item.selected_senses || '').split(',').map(s => s.trim()).filter(Boolean);
            const color = stringToColor(name).substring(1);
            const card = document.createElement('div');
            card.className = 'result-card rounded-xl overflow-hidden flex flex-col fade-in';
            card.style.animationDelay = `${Math.min(index * 50, 1000)}ms`; // é™åˆ¶æœ€å¤§å»¶é²
            card.innerHTML = `
                <div class="aspect-video bg-gray-100 overflow-hidden">
                    <img src="https://placehold.co/600x400/${color}/FFFFFF?text=${encodeURIComponent(name.charAt(0))}&font=inter" alt="${name}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy">
                </div>
                <div class="p-4 flex flex-col flex-grow">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">${item.category || (isEvent ? 'æ´»å‹•' : 'åœ°é»')}</p>
                    <h3 class="font-bold text-lg mt-1 tracking-tight line-clamp-2">${name}</h3>
                    <p class="text-sm text-gray-500 line-clamp-1">${item.address || item.district || ''}</p>
                    <div class="mt-3 pt-3 border-t border-gray-100 flex flex-wrap gap-1.5">${senses.map(s => `<span class="bg-gray-100 text-gray-700 text-xs font-medium px-2 py-1 rounded-full">${s}</span>`).join('')}</div>
                    <div class="mt-auto pt-4 flex gap-2">
                        <button class="view-details-btn w-full bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200">${isEvent ? 'æŸ¥çœ‹æ´»å‹•' : 'æŸ¥çœ‹å°åº—'}</button>
                        <button title="æ–°å¢åˆ°æˆ‘çš„è¡Œç¨‹" class="add-to-trip-btn flex-shrink-0 bg-gray-100 text-gray-600 p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                        </button>
                    </div>
                </div>`;
            card.querySelector('.view-details-btn').addEventListener('click', () => openModal(item));
            card.querySelector('.add-to-trip-btn').addEventListener('click', (e) => {
                e.stopPropagation(); handleAddToTrip(item);
                const btn = e.currentTarget;
                btn.classList.add('bg-green-100', 'text-green-800', 'active-animation');
                setTimeout(() => btn.classList.remove('bg-green-100', 'text-green-800', 'active-animation'), 1000);
            });
            resultsGrid.appendChild(card);
        });
    }

    function openModal(item) {
        const isEvent = 'title' in item;
        const name = item.name || item.title;
        const senses = (item.senses || item.selected_senses || '').split(',').map(s => s.trim()).filter(Boolean);
        const color = stringToColor(name).substring(1);
        let dateStr = '';
        if (isEvent) {
             const start = parseFirestoreDate(item.start_date);
             const end = parseFirestoreDate(item.end_date);
             if (start) {
                 dateStr = `<p class="text-sm text-blue-600 font-semibold mt-2">${start.toLocaleDateString('zh-HK')}${end && end.getTime() !== start.getTime() ? ' - ' + end.toLocaleDateString('zh-HK') : ''}</p>`;
             }
        }
        modalContent.innerHTML = `
            <div class="relative">
                <button id="modal-close-btn" class="absolute -top-2 -right-2 sm:-top-4 sm:-right-4 bg-white rounded-full p-1.5 shadow-md hover:bg-gray-100 z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                </button>
                <div class="w-full aspect-video bg-gray-100 rounded-lg overflow-hidden mb-4">
                    <img src="https://placehold.co/800x400/${color}/FFFFFF?text=${encodeURIComponent(name)}&font=inter" alt="${name}" class="w-full h-full object-cover">
                </div>
                <h3 class="font-bold text-xl sm:text-2xl tracking-tight">${name}</h3>
                <p class="text-gray-500 mt-1">${item.address || item.district || ''}</p>
                ${dateStr}
                <div class="mt-4 pt-4 border-t border-gray-100 flex flex-wrap gap-2">${senses.map(s => `<span class="bg-gray-100 text-gray-700 text-xs font-medium px-2 py-1 rounded-full">${s}</span>`).join('')}</div>
                <p class="text-gray-600 mt-4 whitespace-pre-line">${item.description || 'æš«ç„¡æè¿°ã€‚'}</p>
                <div class="mt-6 flex gap-2">
                    <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="fancy-btn block w-full text-center font-bold py-3 px-6 rounded-lg">${isEvent ? 'å‰å¾€æ´»å‹•ç¶²ç«™' : 'å‰å¾€å°åº—ç¶²ç«™'}</a>
                    <button title="æ–°å¢åˆ°æˆ‘çš„è¡Œç¨‹" id="modal-add-to-trip-btn" class="add-to-trip-btn flex-shrink-0 bg-gray-100 text-gray-600 p-3 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                    </button>
                </div>
            </div>`;
        modalBackdrop.classList.remove('hidden');
        setTimeout(() => modalBackdrop.classList.remove('modal-enter'), 10);
        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        document.getElementById('modal-add-to-trip-btn').addEventListener('click', (e) => {
            handleAddToTrip(item);
            const btn = e.currentTarget;
            btn.classList.add('bg-green-100', 'text-green-800', 'active-animation');
            setTimeout(() => btn.classList.remove('bg-green-100', 'text-green-800', 'active-animation'), 1000);
        });
    }
    function closeModal() { modalBackdrop.classList.add('modal-enter'); setTimeout(() => modalBackdrop.classList.add('hidden'), 300); }

    // --- Event Listeners ---
    districtSelect.addEventListener('change', performSearch);
    searchInput.addEventListener('input', performSearch);
    modalBackdrop.addEventListener('click', e => { if (e.target === modalBackdrop) closeModal(); });
    tabButtons.forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.page)));
    resultFilterButtons.forEach(btn => btn.addEventListener('click', () => {
        resultFilterButtons.forEach(b => b.classList.remove('active')); btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        dateScroller.classList.toggle('hidden', currentFilter !== 'events');
        selectedDate = 'all';
        dateScroller.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
        dateScroller.querySelector('.date-btn[data-date="all"]')?.classList.add('active');
        performSearch();
    }));
    dateScroller.addEventListener('click', e => {
        const btn = e.target.closest('.date-btn');
        if (btn) {
            dateScroller.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); selectedDate = btn.dataset.date; performSearch();
        }
    });

    // --- Init ---
    if (db && auth) {
        console.log("ğŸš€ App Starting...");
        populateSenses(); populateDateScroller(); fetchData(); showPage('explore-page');
    } else { console.error("âŒ Firebase not ready."); }
</script>
</body>
</html>
