<!DOCTYPE html>
<html lang="zh-HK"> <!-- 設為繁體中文 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nose.h.k | sensory discovery</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" href="public/icon.png" type="image/png">

    <!-- ▼▼▼ 樣式更新 ▼▼▼ -->
    <style>
        /* (全局樣式, Header/Nav, 篩選器, 卡片, Modal 樣式... 基本不變) */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f8fa; /* Slightly lighter gray */
            padding-bottom: 80px; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #adb5bd; }
        button, a, select, input, .result-card, .filter-btn, .sense-btn, .date-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        /* Header and Nav Styles with slight transparency and blur */
        .header-nav-style {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .bottom-nav-style {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }
        /* Filter Button Styles */
        .filter-btn { position: relative; color: #6b7280; font-weight: 500; }
        .filter-btn.active { color: #111827; }
        .filter-btn::after {
            content: ''; position: absolute; bottom: -1px; left: 50%;
            width: 0; height: 2px; background-color: #111827;
            transition: all 0.3s ease; transform: translateX(-50%);
        }
        .filter-btn.active::after { width: 50%; }
        /* Sense Button Styles */
        .sense-btn { border: 1px solid #e5e7eb; background-color: #ffffff; }
        .sense-btn:hover { transform: translateY(-2px); border-color: #d1d5db; }
        .sense-btn.active { background-color: #374151; color: #ffffff; border-color: #374151; }
        /* Date Scroller Styles */
        #date-scroller { -ms-overflow-style: none; scrollbar-width: none; }
        #date-scroller::-webkit-scrollbar { display: none; }
        .date-btn {
            display: inline-block; white-space: nowrap; padding: 8px 16px;
            border-radius: 20px; background-color: #ffffff; border: 1px solid #e5e7eb;
            color: #374151; font-weight: 500; font-size: 0.875rem; margin-right: 8px; cursor: pointer;
        }
        .date-btn:hover { background-color: #f3f4f6; transform: translateY(-2px); }
        .date-btn.active {
            background-color: #212529; color: #ffffff; border-color: #212529;
            box-shadow: 0 4px 15px rgba(33, 37, 41, 0.1);
        }
        /* Result Card Styles */
        .result-card {
            background-color: #ffffff; border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.03), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
        }
        .result-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
        }
        /* Modal Styles */
        #modal-backdrop, #suggestion-modal-backdrop { transition: opacity 0.3s ease; }
        #modal-content, #suggestion-modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; }
        .modal-enter .modal-content-transform { transform: scale(0.95) translateY(10px); }
        .modal-enter-active .modal-content-transform { transform: scale(1) translateY(0); }
        /* Tab Bar Styles */
        .tab-btn { color: #9ca3af; }
        .tab-btn.active { color: #111827; }
        .tab-btn:hover { color: #374151; }
        .tab-btn svg { transition: transform 0.2s ease; }
        .tab-btn:hover svg { transform: scale(1.1); }
        /* Add to Trip/Save Button Styles */
        .add-to-trip-btn { transition: all 0.2s ease; }
        .add-to-trip-btn:hover { transform: scale(1.1); background-color: #e5e7eb; }
        .add-to-trip-btn.active-animation svg { animation: pop 0.5s ease; }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(15deg); }
            100% { transform: scale(1); }
        }

        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 4px; }
        .calendar-day-name { text-align: center; font-size: 0.75rem; color: #6b7280; padding-bottom: 4px; }
        .calendar-day { 
            position: relative; width: 100%; aspect-ratio: 1 / 1; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.875rem; border-radius: 9999px; cursor: pointer; 
            transition: background-color 0.2s, color 0.2s;
        }
        .calendar-day.empty { cursor: default; background-color: transparent !important; color: transparent !important; }
        .calendar-day:not(.empty):hover { background-color: #f3f4f6; }
        .calendar-day.today { font-weight: 600; background-color: #eef2ff; color: #4338ca; }
        .calendar-day.selected { background-color: #374151; color: #ffffff; }
        .calendar-day.has-trip::after {
            content: ''; position: absolute; bottom: 10%; left: 50%;
            transform: translateX(-50%); width: 5px; height: 5px;
            border-radius: 50%; background-color: #ef4444; 
        }
        .calendar-day.selected.has-trip::after { background-color: #ffffff; } /* White dot on selected day */

        /* Suggestion Modal Styles */
        .suggestion-item { display: flex; align-items: center; padding: 8px; border-radius: 8px; cursor: pointer; }
        .suggestion-item:hover { background-color: #f9fafb; }
        .suggestion-item input { margin-right: 12px; width: 1.1rem; height: 1.1rem; }
        
        /* ▼▼▼ 新增：行程規劃頁面分頁標籤 (Tabs) 樣式 ▼▼▼ */
        .planner-tab-btn {
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .planner-tab-btn:hover {
            color: #374151;
            border-bottom-color: #d1d5db;
        }
        .planner-tab-btn.active {
            color: #111827;
            border-bottom-color: #111827;
        }
        /* ▲▲▲ 結束分頁標籤樣式 ▲▲▲ */
    </style>
</head>
<body class="text-gray-800">

    <!-- Header (不變) -->
    <header class="header-nav-style sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <img src="public/icon.png" alt="logo" class="h-8 w-8">
                    <div>
                        <h1 class="text-lg font-bold tracking-tight">nose.h.k</h1> 
                        <p class="text-xs text-gray-500">Sensory Discovery</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-sm font-medium flex-shrink-0">
                    <a href="https://forms.gle/Fz9KQkVYynCBQgfm7" target="_blank" class="py-2 px-4 rounded-lg hover:bg-gray-100/80">
                        <span class="sm:hidden">登記</span>
                        <span class="hidden sm:inline">小店/活動登記</span>
                    </a>
                    <div id="auth-container" class="flex items-center gap-2 text-sm font-medium">
                        <!-- Auth UI will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div id="page-container">
        <!-- Explore Page (不變) -->
        <main id="explore-page" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <section id="filters" class="bg-white p-6 rounded-2xl shadow-lg shadow-gray-500/5 mb-8 border border-gray-200/50">
                <h2 class="text-xl font-bold mb-1 tracking-tight">Discover by senses —</h2>
                <p class="text-gray-500 mb-5">Pick one or more senses and explore Events & Local Shops curated for you.</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <div id="senses-container" class="flex flex-wrap gap-2 items-center"></div>
                    <div class="flex-grow flex flex-col sm:flex-row gap-3 mt-2 sm:mt-0">
                        <select id="district-select" class="w-full sm:w-40 p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-gray-400 focus:border-gray-400 outline-none">
                            <option value="all">所有地區</option>
                        </select>
                        <input type="text" id="search-input" placeholder="搜尋活動或小店..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400 outline-none">
                    </div>
                </div>
            </section>
            
            <section id="results-container">
                 <div class="mb-4">
                    <div class="flex items-center gap-2 text-sm font-medium border-b border-gray-200">
                        <button data-filter="events" class="filter-btn active py-3 px-5">活動</button>
                        <button data-filter="places" class="filter-btn py-3 px-5">本地小店</button>
                    </div>
                </div>
                <div id="date-scroller" class="mb-6 -mt-2 pb-2 overflow-x-auto whitespace-nowrap">
                    <!-- Date buttons for events -->
                </div>
                <p id="results-count" class="text-sm text-gray-500 mb-4"></p>
                <div id="loader" class="text-center py-10"><p class="text-gray-500">正在加載體驗...</p></div>
                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="no-results" class="hidden text-center py-16">
                    <p class="text-lg text-gray-600">找不到任何體驗。</p>
                    <p class="text-gray-500">請嘗試調整你的篩選條件。</p>
                </div>
            </section>
        </main>
        
        <!-- ▼▼▼ "我的行程" 頁面結構已更新，包含分頁標籤 ▼▼▼ -->
        <main id="planner-page" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="planner-content">
                <!-- JS 會根據登入狀態填入登入提示或分頁內容 -->
            </div>
        </main>
        <!-- ▲▲▲ 結束結構更新 ▲▲▲ -->

    </div>

    <!-- Bottom Tab Bar (不變) -->
    <nav class="bottom-nav-style fixed bottom-0 left-0 right-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-around">
            <button data-page="explore-page" class="tab-btn active flex-1 flex flex-col items-center justify-center py-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M9.69 2.522a.75.75 0 01.62 0l6.25 2.5a.75.75 0 01.44 1.012l-2.5 6.25a.75.75 0 01-1.012.44l-6.25-2.5a.75.75 0 01-.44-1.012l2.5-6.25a.75.75 0 011.012-.44zM8.5 9.75a.75.75 0 00-1.06-1.06l-1.5 1.5a.75.75 0 001.06 1.06l1.5-1.5zm2.56-1.06a.75.75 0 011.06 0l1.5 1.5a.75.75 0 01-1.06 1.06l-1.5-1.5a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg>
                <span class="text-xs font-medium">探索</span>
            </button>
            <button data-page="planner-page" class="tab-btn flex-1 flex flex-col items-center justify-center py-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path d="M5.5 16.5a1.5 1.5 0 01-1.5-1.5V5A1.5 1.5 0 015.5 3.5h9A1.5 1.5 0 0116 5v10a1.5 1.5 0 01-1.5 1.5h-9zM7 6a1 1 0 00-1 1v1a1 1 0 001 1h6a1 1 0 001-1V7a1 1 0 00-1-1H7z" /></svg>
                <span class="text-xs font-medium">我的</span> <!-- 改為"我的" -->
            </button>
        </div>
    </nav>
    
    <!-- 原本的詳情 Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 hidden z-30 modal-enter">
        <div id="modal-content" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl bg-white rounded-2xl shadow-xl p-4 sm:p-6 modal-content-transform"></div>
    </div>

    <!-- 建議彈窗 -->
    <div id="suggestion-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden z-40 modal-enter">
        <div id="suggestion-modal-content" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-lg bg-white rounded-2xl shadow-xl p-6 modal-content-transform">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">建立你的行程</h3>
                <button id="suggestion-modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                </button>
            </div>
            <div id="suggestion-primary-item" class="mb-4"></div>
            <h4 id="suggestion-title" class="text-md font-semibold text-gray-700 mb-2"></h4>
            <div id="suggestion-list" class="max-h-48 overflow-y-auto space-y-2 mb-6 pr-2"></div>
            <button id="suggestion-confirm-btn" class="w-full bg-gray-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors">確認並建立行程</button>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="text-center py-8 border-t border-gray-200">
        <p class="text-sm text-gray-500">版權所有 © 2025 nostartnoend.hk</p>
    </footer>

    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // ▼▼▼ 引入更多 Firestore 功能 ▼▼▼
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, arrayUnion, query, where, Timestamp, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; 
    
        const firebaseConfig = {
            apiKey: "AIzaSyBHw_5ApaAa6N18ym4QnzJwmoxWRP3M4Ac",
            authDomain: "nostartnoendhk-11a6a.firebaseapp.com",
            projectId: "nostartnoendhk-11a6a",
            storageBucket: "nostartnoendhk-11a6a.appspot.com",
            messagingSenderId: "1394470229",
            appId: "1:1394470229:web:e20dd66a469aaaf429d3dc",
            measurementId: "G-733PSHDR5L"
        };
        
        let app;
        let auth;
        let db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Firebase initialization error:", e);
            document.body.innerHTML = `<p style="color: red; padding: 20px;">Error initializing Firebase. Check console/config.</p>`;
        }

        const SENSES = ['Eye', 'Ear', 'Nose', 'Tongue', 'Body', 'Mind'];
        const SENSES_ZH = ['眼', '耳', '鼻', '舌', '身', '意'];

        let allPlaces = [];
        let allEvents = [];
        let userTrips = []; // 只儲存事件行程
        let userSavedPlaces = []; // 新增：儲存心水小店
        let currentFilter = 'events'; // 預設顯示活動
        let selectedDate = 'all'; 

        let currentSuggestionItem = null; 
        let calendarMonth = new Date(); 
        let selectedCalendarDate = null; 
        let currentPlannerTab = 'calendar'; // 新增：記錄 Planner 頁面當前分頁

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const sensesContainer = document.getElementById('senses-container');
        const districtSelect = document.getElementById('district-select');
        const searchInput = document.getElementById('search-input');
        const resultsGrid = document.getElementById('results-grid');
        const loader = document.getElementById('loader');
        const noResults = document.getElementById('no-results');
        const resultsCount = document.getElementById('results-count');
        const resultFilterButtons = document.querySelectorAll('.filter-btn');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const tabButtons = document.querySelectorAll('.tab-btn[data-page]');
        const explorePage = document.getElementById('explore-page');
        const plannerPage = document.getElementById('planner-page');
        const plannerContent = document.getElementById('planner-content'); // Planner 頁面嘅內容容器
        const dateScroller = document.getElementById('date-scroller');
        const suggestionModalBackdrop = document.getElementById('suggestion-modal-backdrop');
        const suggestionModalContent = document.getElementById('suggestion-modal-content');
        const suggestionPrimaryItem = document.getElementById('suggestion-primary-item');
        const suggestionTitle = document.getElementById('suggestion-title');
        const suggestionList = document.getElementById('suggestion-list');
        const suggestionConfirmBtn = document.getElementById('suggestion-confirm-btn');
        const suggestionModalCloseBtn = document.getElementById('suggestion-modal-close-btn');

        // --- PAGE NAVIGATION ---
        function showPage(pageId) {
            explorePage.classList.add('hidden');
            plannerPage.classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');

            tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });
            if (pageId === 'planner-page' && auth) {
                renderPlannerPage(auth.currentUser); // 確保每次切換都渲染
            }
        }

        // --- AUTHENTICATION ---
        const provider = new GoogleAuthProvider();
        function handleSignIn() { 
            if (!auth) { console.error("Auth not initialized."); return; }
            signInWithPopup(auth, provider).catch(error => console.error("Sign in error:", error));
        }
        function handleSignOut() { 
            if (!auth) { console.error("Auth not initialized."); return; }
            signOut(auth).catch(error => console.error("Sign out error:", error));
        }

        if (auth) {
             onAuthStateChanged(auth, user => {
                renderAuthUI(user);
                // ▼▼▼ 修改：登入/登出時，獲取兩種資料 ▼▼▼
                if (user && db) { 
                    fetchUserTrips(user.uid); 
                    fetchSavedPlaces(user.uid); // 新增：獲取心水小店
                } else {
                    userTrips = []; 
                    userSavedPlaces = []; // 新增：清空心水小店
                }
                // 無論登入登出，都重新渲染 Planner 頁面
                renderPlannerPage(user); 
             });
        }

        function renderAuthUI(user) { 
            authContainer.innerHTML = '';
            if (user) {
                authContainer.innerHTML = `
                    <img src="${user.photoURL}" alt="${user.displayName}" class="w-8 h-8 rounded-full">
                    <button id="logout-btn" class="py-2 px-4 rounded-md hover:bg-gray-100 transition-colors">登出</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', handleSignOut);
            } else {
                authContainer.innerHTML = `<button id="login-btn" class="bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors">Google 登入</button>`;
                document.getElementById('login-btn').addEventListener('click', handleSignIn);
            }
        }

        // --- TRIP PLANNER & SAVED PLACES LOGIC ---

        // ▼▼▼ "我的" 頁面渲染邏輯已完全重構 ▼▼▼
        function renderPlannerPage(user) {
             if (!user) {
                 // 未登入提示 (不變)
                 plannerContent.innerHTML = `
                    <div class="text-center py-16">
                        <h2 class="text-2xl font-bold mb-2">我的收藏</h2>
                        <p class="text-gray-600 mb-4">請先登入以查看你的行程及心水小店。</p>
                        <button id="planner-login-btn" class="bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors">Google 登入</button>
                    </div>
                 `;
                 const loginBtn = document.getElementById('planner-login-btn');
                 if (loginBtn) loginBtn.addEventListener('click', handleSignIn);
             } else {
                 // 已登入，顯示分頁
                 plannerContent.innerHTML = `
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button data-tab="calendar" class="planner-tab-btn ${currentPlannerTab === 'calendar' ? 'active' : ''}">行程日曆</button>
                            <button data-tab="saved_places" class="planner-tab-btn ${currentPlannerTab === 'saved_places' ? 'active' : ''}">心水小店</button>
                        </nav>
                    </div>

                    <div id="planner-tab-content">
                        <!-- JS 會根據 currentPlannerTab 填入內容 -->
                    </div>
                 `;
                 
                 // 根據當前選擇嘅分頁渲染對應內容
                 renderPlannerTabContent();

                 // 綁定分頁按鈕事件
                 plannerContent.querySelectorAll('.planner-tab-btn').forEach(btn => {
                     btn.addEventListener('click', () => {
                         currentPlannerTab = btn.dataset.tab;
                         // 更新按鈕樣式
                         plannerContent.querySelectorAll('.planner-tab-btn').forEach(b => b.classList.remove('active'));
                         btn.classList.add('active');
                         // 渲染新分頁內容
                         renderPlannerTabContent();
                     });
                 });
             }
        }

        // 新增：渲染 Planner 頁面嘅分頁內容
        function renderPlannerTabContent() {
            const tabContentContainer = document.getElementById('planner-tab-content');
            if (!tabContentContainer) return;

            if (currentPlannerTab === 'calendar') {
                // 渲染日曆框架
                tabContentContainer.innerHTML = `
                    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg shadow-gray-500/5 border border-gray-200/50">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-lg hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 010 1.06L9.06 10l3.73 3.71a.75.75 0 11-1.06 1.06l-4.25-4.25a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 0z" clip-rule="evenodd" /></svg></button>
                            <h2 id="calendar-month-year" class="text-lg font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-lg hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 010-1.06L10.94 10 7.21 6.29a.75.75 0 111.06-1.06l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06 0z" clip-rule="evenodd" /></svg></button>
                        </div>
                        <div class="calendar-grid mb-1">
                            ${['日', '一', '二', '三', '四', '五', '六'].map(d => `<div class="calendar-day-name">${d}</div>`).join('')}
                        </div>
                        <div id="calendar-days-grid" class="calendar-grid"></div>
                    </div>
                    <div id="selected-day-trips" class="mt-6"></div>
                `;
                renderCalendar(); // 填入日期
                // 綁定月份切換
                document.getElementById('prev-month-btn')?.addEventListener('click', () => changeMonth(-1));
                document.getElementById('next-month-btn')?.addEventListener('click', () => changeMonth(1));

            } else if (currentPlannerTab === 'saved_places') {
                // 渲染心水小店列表框架
                tabContentContainer.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">心水小店</h2>
                    <div id="saved-places-list" class="space-y-4">
                       <!-- JS 會喺呢度填入小店 -->
                       <p class="text-gray-500 text-center py-8">正在載入心水小店...</p>
                    </div>
                `;
                renderSavedPlaces(); // 填入小店列表
            }
        }

        // 渲染日曆
        function renderCalendar() {
            const daysGrid = document.getElementById('calendar-days-grid');
            const monthYearText = document.getElementById('calendar-month-year');
            if (!daysGrid || !monthYearText) return;

            calendarMonth.setDate(1); // Set to the first day of the month
            const month = calendarMonth.getMonth();
            const year = calendarMonth.getFullYear();

            monthYearText.textContent = `${year}年 ${month + 1}月`;

            daysGrid.innerHTML = '';

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon...
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Add empty cells for days before the 1st
            for (let i = 0; i < firstDayOfMonth; i++) {
                daysGrid.innerHTML += `<div class="calendar-day empty"></div>`;
            }

            const today = new Date();
            today.setHours(0,0,0,0);

            // Add day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                date.setHours(0,0,0,0);
                const dateString = date.toISOString().split('T')[0]; // YYYY-MM-DD format

                const isToday = date.getTime() === today.getTime();
                const isSelected = selectedCalendarDate === dateString;
                
                // 檢查 userTrips 中是否有呢一日嘅行程
                const hasTrip = userTrips.some(trip => {
                     const tripDate = parseFirestoreDate(trip.tripDate); // 用輔助函式處理 Timestamp 或 String
                     return tripDate && tripDate.toISOString().split('T')[0] === dateString;
                });

                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.textContent = day;
                dayElement.dataset.date = dateString;

                if (isToday) dayElement.classList.add('today');
                if (isSelected) dayElement.classList.add('selected');
                if (hasTrip) dayElement.classList.add('has-trip');

                dayElement.addEventListener('click', () => {
                    selectedCalendarDate = dateString;
                    renderCalendar(); // Re-render to show selection
                    renderSelectedDayTrips(dateString); // Show trips for the selected day
                });

                daysGrid.appendChild(dayElement);
            }
             // Render trips for the initially selected date (if any)
            if (selectedCalendarDate) {
                 renderSelectedDayTrips(selectedCalendarDate);
            } else {
                 document.getElementById('selected-day-trips').innerHTML = ''; // Clear trips if no date selected
            }
        }

        // 切換月份
        function changeMonth(delta) {
            calendarMonth.setMonth(calendarMonth.getMonth() + delta);
            selectedCalendarDate = null; // Clear selection when changing month
            renderCalendar();
        }

        // 渲染選定日期的行程
        function renderSelectedDayTrips(dateString) {
             const container = document.getElementById('selected-day-trips');
             if (!container) return;

             const tripsForDay = userTrips.filter(trip => {
                 const tripDate = parseFirestoreDate(trip.tripDate);
                 return tripDate && tripDate.toISOString().split('T')[0] === dateString;
             });

             if (tripsForDay.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500">這天沒有行程。</p>`;
                 return;
             }

             container.innerHTML = `
                <h3 class="text-lg font-bold mb-3">${dateString} 的行程</h3>
                <div class="space-y-4">
                    ${tripsForDay.map(trip => `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200/50">
                            <h4 class="font-bold mb-2">${trip.name}</h4>
                            <div class="space-y-2">
                                ${trip.items.map(item => `
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-semibold text-sm">${item.name || item.title}</p>
                                            <p class="text-xs text-gray-500">${item.category}</p>
                                        </div>
                                         ${item.url ? `<a href="${item.url}" target="_blank" class="text-xs font-medium text-blue-600 hover:underline">查看</a>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
             `;
        }
        
        // 渲染心水小店列表
        function renderSavedPlaces() {
            const container = document.getElementById('saved-places-list');
            if (!container) return; 

            if (!userSavedPlaces || userSavedPlaces.length === 0) { // Add check for undefined
                container.innerHTML = `<p class="text-gray-500 text-center py-8">你仲未收藏任何小店。喺「探索」頁面搵到鍾意嘅小店，點擊<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline-block mx-1"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14 7 7 0 000-14zM2 10a8 8 0 1116 0 8 8 0 01-16 0zm9.75-2.75a.75.75 0 00-1.5 0v2h-2a.75.75 0 000 1.5h2v2a.75.75 0 001.5 0v-2h2a.75.75 0 000-1.5h-2v-2z" clip-rule="evenodd" /></svg>按鈕就可以加入啦！</p>`;
                return;
            }

            // 按加入時間排序
            userSavedPlaces.sort((a,b) => (b.saved_at?.toDate ? b.saved_at.toDate().getTime() : 0) - (a.saved_at?.toDate ? a.saved_at.toDate().getTime() : 0));

            container.innerHTML = userSavedPlaces.map(place => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200/50 flex justify-between items-center fade-in">
                    <div>
                        <h4 class="font-bold">${place.name || '未知小店'}</h4>
                        <p class="text-sm text-gray-500">${place.category || ''} • ${place.district || ''}</p>
                    </div>
                    <div class="flex items-center gap-2">
                         <button data-place-id="${place.id}" title="移除收藏" class="remove-saved-place-btn text-gray-400 hover:text-red-500 p-1 rounded-full">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                         </button>
                         ${place.url ? `<a href="${place.url}" target="_blank" rel="noopener noreferrer" class="text-sm font-medium text-blue-600 hover:underline ml-2">查看</a>` : ''}
                    </div>
                </div>
            `).join('');

             container.querySelectorAll('.remove-saved-place-btn').forEach(btn => {
                 btn.addEventListener('click', () => removeSavedPlace(btn.dataset.placeId));
             });
        }
        
        async function removeSavedPlace(placeDocId) {
             if (!db || !placeDocId) return;
             console.log(`Removing saved place ${placeDocId}`);
             try {
                 await deleteDoc(doc(db, "saved_places", placeDocId));
                 console.log("Place removed successfully."); // Snapshot listener will update UI
             } catch (e) {
                 console.error("Error removing saved place:", e);
                 alert("移除小店時發生錯誤。");
             }
        }

        function fetchUserTrips(userId) { /* ... 不變 ... */ }

        // 獲取心水小店
        function fetchSavedPlaces(userId) {
            if (!db) { console.error("DB not initialized for fetchSavedPlaces"); return; }
            console.log(`Fetching saved places for user ${userId}`);
            const q = query(collection(db, "saved_places"), where("userId", "==", userId));
            
            onSnapshot(q, (snapshot) => {
                console.log(`Received ${snapshot.docs.length} saved places snapshot.`);
                userSavedPlaces = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Update UI only if the saved places tab might be visible
                if (!plannerPage.classList.contains('hidden') && currentPlannerTab === 'saved_places') {
                    renderSavedPlaces();
                }
            }, (error) => {
                console.error("Error fetching saved places:", error);
                 const container = document.getElementById('saved-places-list');
                 if(container) container.innerHTML = `<p class="text-red-500 text-center py-8">無法載入心水小店資料。</p>`;
            });
        }
        
        // ▼▼▼ `handleAddToTrip` (加入心水) 已重寫 ▼▼▼
        async function handleAddToTrip(item, event) { // Pass event object
             const user = auth?.currentUser;
             if (!user) {
                 alert("請先登入，才能收藏項目或規劃行程。"); 
                 handleSignIn(); 
                 return;
             }
             if (!db) { console.error("DB not initialized"); return; }
             
             const isEvent = 'title' in item;

             if (isEvent) {
                 // **處理活動：打開建議彈窗**
                 currentSuggestionItem = item; // Store the event
                 openSuggestionModal(item);
             } else {
                 // **處理小店：直接儲存到 saved_places**
                 console.log("Attempting to save place:", item);
                 const placeData = {
                     userId: user.uid,
                     saved_at: Timestamp.now(), 
                     name: item.name,
                     category: item.category,
                     district: item.district,
                     address: item.address,
                     url: item.url,
                     senses: item.senses,
                     // Store the original ID from the 'places' collection if available
                     originalPlaceId: item.id || null 
                 };
                 Object.keys(placeData).forEach(key => placeData[key] == null && delete placeData[key]);

                 try {
                      // Check if already saved (optional but good practice)
                      // This requires a slightly more complex query, skipping for simplicity now.
                      await addDoc(collection(db, "saved_places"), placeData);
                      console.log(`Place "${placeData.name}" saved successfully.`);
                      
                      const btn = event?.target.closest('.add-to-trip-btn'); // Use optional chaining
                      if (btn) {
                           btn.classList.add('active-animation');
                           setTimeout(() => btn.classList.remove('active-animation'), 500);
                      }
                 } catch (e) {
                      console.error("Error saving place: ", e);
                      alert("加入心水小店時發生錯誤。");
                 }
             }
        }
        
        // `openSuggestionModal` (查找同區小店)
        function openSuggestionModal(eventItem) {
             if (!eventItem || !eventItem.district) {
                 console.error("Event item or district missing for suggestions.");
                 return; // Cannot suggest without district
             }
             console.log("Opening suggestions for event:", eventItem.title);

             suggestionPrimaryItem.innerHTML = `
                <div class="flex items-center gap-3 p-3 bg-gray-100 rounded-lg border border-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 text-blue-500 flex-shrink-0"><path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c0-.414.336-.75.75-.75h10.5a.75.75 0 010 1.5H5.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                    <div>
                        <p class="font-bold">${eventItem.title}</p>
                        <p class="text-sm text-gray-500">${eventItem.start_date}</p>
                    </div>
                </div>`;
             
             suggestionTitle.textContent = `想唔想將 ${eventItem.district} 嘅小店加入行程？`;
             
             // 找出同區嘅小店 (從 allPlaces 陣列)
             const suggestedPlaces = allPlaces.filter(place => place.district === eventItem.district);
             
             if (suggestedPlaces.length === 0) {
                 suggestionList.innerHTML = `<p class="text-sm text-gray-500 italic">喺 ${eventItem.district} 暫時搵唔到可以加入嘅小店。</p>`;
             } else {
                 suggestionList.innerHTML = suggestedPlaces.map((place, index) => `
                    <label for="suggestion-${index}" class="suggestion-item">
                        <input type="checkbox" id="suggestion-${index}" name="suggestion" value="${place.id}" class="rounded border-gray-300 text-gray-800 focus:ring-gray-700">
                        <div>
                           <p class="font-medium text-gray-800">${place.name}</p>
                           <p class="text-xs text-gray-500">${place.category}</p>
                        </div>
                    </label>
                 `).join('');
                 // Store place data with checkbox for easy retrieval later
                 suggestionList.querySelectorAll('input[name="suggestion"]').forEach((checkbox, index) => {
                     checkbox.placeData = suggestedPlaces[index]; 
                 });
             }

             suggestionModalBackdrop.classList.remove('hidden');
             setTimeout(() => suggestionModalBackdrop.classList.remove('modal-enter'), 10);
        }

        // `closeSuggestionModal` (不變)
        function closeSuggestionModal() { 
            suggestionModalBackdrop.classList.add('modal-enter');
            setTimeout(() => {
                suggestionModalBackdrop.classList.add('hidden');
                // Clear content for next use
                suggestionPrimaryItem.innerHTML = ''; 
                suggestionList.innerHTML = ''; 
                currentSuggestionItem = null;
            }, 300);
        }

        // `handleSuggestionConfirm` (只儲存到 trips)
        async function handleSuggestionConfirm() {
             const user = auth?.currentUser;
             if (!user || !currentSuggestionItem || !('title' in currentSuggestionItem) || !db) return; 
             
             console.log("Confirming trip creation for event:", currentSuggestionItem.title);
             
             // 1. 主要項目 (一定係 Event)
             let tripItems = [formatItemForTrip(currentSuggestionItem)];

             // 2. 獲取選中嘅小店
             const checkedBoxes = suggestionList.querySelectorAll('input[name="suggestion"]:checked');
             checkedBoxes.forEach(box => { 
                 if (box.placeData) { // 從 checkbox 讀取返小店資料
                     tripItems.push(formatItemForTrip(box.placeData)); 
                 }
             });
             console.log("Trip items:", tripItems);
             
             // 3. 行程名稱同日期 (基於 Event)
             const primaryItem = currentSuggestionItem;
             let tripName = primaryItem.title; // Use event title as default trip name
             // Trip date should be the event's start date
             let tripDate = parseFirestoreDate(primaryItem.start_date); 
             if (!tripDate) { // Fallback if start_date is invalid/missing
                 console.warn("Event start_date missing or invalid, using today's date for trip.");
                 tripDate = new Date();
             }
             tripDate.setHours(0,0,0,0); // Ensure it's just the date part
             
             console.log(`Trip Name: ${tripName}, Trip Date: ${tripDate.toISOString()}`);

             // 4. 儲存到 `trips` 集合
             try {
                 await addDoc(collection(db, "trips"), { 
                     userId: user.uid,
                     name: tripName,
                     items: tripItems,
                     created_at: Timestamp.now(), 
                     tripDate: Timestamp.fromDate(tripDate) // Store trip date as Timestamp
                 });
                 console.log("New trip created in Firestore!");
                 closeSuggestionModal(); 
                 // Optionally close the main details modal if it's open
                 // closeModal(); 
                 alert("行程已成功建立！");
                 // Switch to planner page and show calendar tab
                 currentPlannerTab = 'calendar'; 
                 showPage('planner-page'); 
             } catch (e) { 
                 console.error("Error saving trip to Firestore:", e);
                 alert("建立行程時發生錯誤。");
             }
        }

        // Helper to format item for storage in trip 'items' array
        function formatItemForTrip(item) {
             const isEvent = 'title' in item;
             return {
                 id: item.id || null, // Original ID from places/events collection
                 name: item.name || item.title || null,
                 category: item.category || null,
                 url: item.url || null,
                 district: item.district || null,
                 isEvent: isEvent 
                 // Add other fields if needed, like address or senses
             };
        }
        
        // --- DATA FETCHING & RENDERING HELPERS ---
        // Helper to parse date string (YYYY-MM-DD) or Firestore Timestamp
        function parseFirestoreDate(dateField) {
             if (!dateField) return null;
             if (dateField.toDate) { // Check if it's a Firestore Timestamp
                 return dateField.toDate();
             }
             if (typeof dateField === 'string') {
                  // Try parsing YYYY-MM-DD
                  const parts = dateField.split('-');
                  if (parts.length === 3) {
                      const [year, month, day] = parts.map(Number);
                      // Check if parts are valid numbers before creating Date
                      if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                          const date = new Date(year, month - 1, day);
                           // Basic validation: Check if year matches (prevents weird dates like 0000)
                          if (date.getFullYear() === year) {
                               return date;
                          }
                      }
                  }
                  // Try parsing as ISO string (less reliable due to timezones)
                  const isoDate = new Date(dateField);
                  if (!isNaN(isoDate.getTime())) {
                       return isoDate;
                  }
             }
             console.warn("Could not parse date:", dateField);
             return null; // Return null if parsing fails
        }
        
        function fetchData() {
             if (!db) { console.error("DB not initialized"); return; }
             loader.style.display = 'block';
             console.log("Fetching data...");

             const handleSnapshot = (snapshot, type) => {
                 console.log(`Received ${type} snapshot with ${snapshot.docs.length} docs.`);
                 const dataArray = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (type === 'places') allPlaces = dataArray;
                 if (type === 'events') allEvents = dataArray;
                 populateDistricts(); // Update districts dropdown
                 populateDateScroller(); // Update date scroller based on new events
                 performSearch(); // Re-filter and render results
             };
             const handleError = (type, error) => { /* ... error handling ... */ };

             try {
                 onSnapshot(collection(db, "places"), (snap) => handleSnapshot(snap, 'places'), (err) => handleError('places', err));
                 onSnapshot(collection(db, "events"), (snap) => handleSnapshot(snap, 'events'), (err) => handleError('events', err));
             } catch(e) { /* ... error handling ... */ }
        }
        
        function stringToColor(str) { /* ... 不變 ... */ }
        function populateSenses() { /* ... 不變 ... */ }
        function populateDistricts() { /* ... 不變 ... */ }
        
        // Populate Date Scroller
        function populateDateScroller() {
            if (currentFilter !== 'events') {
                dateScroller.innerHTML = ''; // Clear if not viewing events
                dateScroller.classList.add('hidden');
                return;
            }
            dateScroller.classList.remove('hidden');

            const dates = new Set(['all']); // Start with 'All'
            const today = new Date();
            today.setHours(0,0,0,0);

            allEvents.forEach(event => {
                const startDate = parseFirestoreDate(event.start_date);
                const endDate = parseFirestoreDate(event.end_date) || startDate; // Use start date if end date missing

                if (startDate && endDate && endDate >= today) { // Only include future or ongoing events
                    let currentDate = new Date(startDate);
                    currentDate.setHours(0,0,0,0);
                    while (currentDate <= endDate) {
                        dates.add(currentDate.toISOString().split('T')[0]);
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
            });

            const sortedDates = Array.from(dates).sort((a, b) => a === 'all' ? -1 : b === 'all' ? 1 : new Date(a) - new Date(b));

            dateScroller.innerHTML = sortedDates.map(date => {
                const isActive = date === selectedDate;
                const text = date === 'all' ? '全部日期' : `${new Date(date).getMonth() + 1}月${new Date(date).getDate()}日`;
                return `<button data-date="${date}" class="date-btn ${isActive ? 'active' : ''}">${text}</button>`;
            }).join('');
        }
        
        // Perform Search (Includes date filtering)
        function performSearch() {
             if (!db || !auth) return; // Ensure Firebase is ready

             const selectedSenses = Array.from(sensesContainer.querySelectorAll('.sense-btn.active')).map(btn => btn.dataset.sense);
             const selectedDistrict = districtSelect.value;
             const searchQuery = searchInput.value.toLowerCase();

             let results = [];
             if (currentFilter === 'events') {
                 results = allEvents;
                 // Filter by selectedDate if it's not 'all'
                 if (selectedDate !== 'all') {
                     results = results.filter(event => {
                         const startDate = parseFirestoreDate(event.start_date);
                         const endDate = parseFirestoreDate(event.end_date) || startDate;
                         const targetDate = new Date(selectedDate);
                         targetDate.setHours(0,0,0,0); // Ensure comparison is date only
                         
                         return startDate && endDate && targetDate >= startDate && targetDate <= endDate;
                     });
                 }
             } else if (currentFilter === 'places') {
                 results = allPlaces;
             }
             // 'all' filter is handled by filter buttons, not needed here explicitly

             const filtered = results.filter(item => {
                 const name = item.name || item.title;
                 if (!name) return false;
                 
                 const districtMatch = selectedDistrict === 'all' || item.district === selectedDistrict;
                 const senses = item.senses || item.selected_senses || '';
                 const sensesMatch = selectedSenses.length === 0 || selectedSenses.every(s => senses.includes(s));
                 const searchMatch = searchQuery === '' || name.toLowerCase().includes(searchQuery);
                 
                 // Add date check (for events only, handled above if specific date selected)
                 let dateMatch = true; 
                 const isEvent = 'title' in item;
                 if (isEvent && selectedDate === 'all') { // Only check expiry if 'All Dates' is selected
                      const endDate = parseFirestoreDate(item.end_date) || parseFirestoreDate(item.start_date);
                      if (endDate) {
                           const today = new Date();
                           today.setHours(0,0,0,0);
                           if (endDate < today) {
                               dateMatch = false; // Exclude past events when showing 'All Dates'
                           }
                      }
                 }

                 return districtMatch && sensesMatch && searchMatch && dateMatch;
             });
             renderResults(filtered);
        }
        
        // Render Results (不變)
        function renderResults(results) { /* ... (邏輯不變) ... */ }
        // Generate Event Details HTML (不變)
        function generateEventDetailsHtml(item) { /* ... (邏輯不變) ... */ }
        // Open Modal (不變)
        function openModal(item) { /* ... (邏輯不變) ... */ }
        // Close Modal (不變)
        function closeModal() { /* ... 不變 ... */ }

        // --- EVENT LISTENERS ---
        if(db && auth) {
             districtSelect.addEventListener('change', performSearch);
             searchInput.addEventListener('input', performSearch);
             
             resultFilterButtons.forEach(button => {
                 button.addEventListener('click', () => {
                     resultFilterButtons.forEach(btn => btn.classList.remove('active'));
                     button.classList.add('active');
                     currentFilter = button.dataset.filter;
                     // Reset date filter when switching main filter
                     selectedDate = 'all'; 
                     populateDateScroller(); // Show/hide/update date scroller
                     performSearch();
                 });
             });
             
             modalBackdrop.addEventListener('click', e => { if (e.target === modalBackdrop) closeModal(); });
             
             tabButtons.forEach(button => {
                 button.addEventListener('click', () => showPage(button.dataset.page));
             });

             dateScroller.addEventListener('click', e => {
                 const target = e.target.closest('.date-btn'); 
                 if (target) {
                     dateScroller.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
                     target.classList.add('active');
                     selectedDate = target.dataset.date;
                     performSearch();
                 }
             });
             
             suggestionModalCloseBtn.addEventListener('click', closeSuggestionModal);
             suggestionModalBackdrop.addEventListener('click', e => { if (e.target === suggestionModalBackdrop) closeSuggestionModal(); });
             suggestionConfirmBtn.addEventListener('click', handleSuggestionConfirm);
        }

        // --- INITIALIZATION ---
        if (db && auth) {
            populateSenses();
            populateDateScroller(); 
            fetchData();
            showPage('explore-page'); 
        } else {
             console.log("Firebase not ready...");
             loader.style.display = 'none';
        }

    </script>
</body>
</html>
