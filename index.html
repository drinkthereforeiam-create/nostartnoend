<!DOCTYPE html>
<html lang="zh-HK"> <!-- 設為繁體中文 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nose.h.k | sensory discovery</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon (Embedded - Assuming you had this from previous versions) -->
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAOVBMVEX///8AAADa2trf39/g4ODd3d3b29vY2NjX19e/v7/y8vLz8/Pj4+Ph4eHu7u729vb5+fna2tqUlJSXl5eOj4qWIAU/AAABPUlEQVR4nO3PMRKAIBADAUH8/6ELCqQDIqF3j9W2rdt2v38A9DlfAQEJSEACEnBAAhKQAAScgAQkIAEJSEACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAgcQkIAEJSEACEvB/4gA9QyXf97GlQAAAAABJRU5ErkJggg==" type="image/png">

    <!-- Styles (Combined from ui.html and previous fixes) -->
    <style>
        /* Global Styles & Animations */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f8fa;
            padding-bottom: 80px; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #adb5bd; }
        button, a, select, input, .result-card, .filter-btn, .sense-btn, .date-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        /* Header & Nav Bar */
        .header-nav-style {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .bottom-nav-style {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* Filters & Buttons */
        .filter-btn { position: relative; color: #6b7280; font-weight: 500; }
        .filter-btn.active { color: #111827; }
        .filter-btn::after {
            content: ''; position: absolute; bottom: -1px; left: 50%;
            width: 0; height: 2px; background-color: #111827;
            transition: all 0.3s ease; transform: translateX(-50%);
        }
        .filter-btn.active::after { width: 50%; }
        .sense-btn { border: 1px solid #e5e7eb; background-color: #ffffff; }
        .sense-btn:hover { transform: translateY(-2px); border-color: #d1d5db; }
        .sense-btn.active { background-color: #374151; color: #ffffff; border-color: #374151; }
        #date-scroller { -ms-overflow-style: none; scrollbar-width: none; }
        #date-scroller::-webkit-scrollbar { display: none; }
        .date-btn {
            display: inline-block; white-space: nowrap; padding: 8px 16px;
            border-radius: 20px; background-color: #ffffff; border: 1px solid #e5e7eb;
            color: #374151; font-weight: 500; font-size: 0.875rem; margin-right: 8px; cursor: pointer;
        }
        .date-btn:hover { background-color: #f3f4f6; transform: translateY(-2px); }
        .date-btn.active {
            background-color: #212529; color: #ffffff; border-color: #212529;
            box-shadow: 0 4px 15px rgba(33, 37, 41, 0.1);
        }

        /* Result Cards */
        .result-card {
            background-color: #ffffff; border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.03), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
        }
        .result-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
        }

        /* Modals */
        #modal-backdrop, #suggestion-modal-backdrop { transition: opacity 0.3s ease; }
        #modal-content, #suggestion-modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; }
        .modal-enter .modal-content-transform { transform: scale(0.95) translateY(10px); }
        .modal-enter-active .modal-content-transform { transform: scale(1) translateY(0); }
        
        /* Bottom Tab Bar */
        .tab-btn { color: #9ca3af; }
        .tab-btn.active { color: #111827; }
        .tab-btn:hover { color: #374151; }
        .tab-btn svg { transition: transform 0.2s ease; }
        .tab-btn:hover svg { transform: scale(1.1); }
        
        /* Add to Trip Button Animation */
        .add-to-trip-btn { transition: all 0.2s ease; }
        .add-to-trip-btn:hover { transform: scale(1.1); background-color: #e5e7eb; }
        .add-to-trip-btn.active-animation svg { animation: pop 0.5s ease; }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(15deg); }
            100% { transform: scale(1); }
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb;
            overflow: hidden; border-radius: 0.5rem;
        }
        .calendar-day-name {
            font-size: 0.75rem; font-weight: 600; color: #4b5563; text-align: center;
            padding: 0.5rem 0.25rem; background-color: #f3f4f6;
        }
        .calendar-day {
            position: relative; padding: 0.75rem 0.5rem; min-height: 80px;
            background-color: #ffffff; font-size: 0.875rem; font-weight: 500;
            cursor: pointer; transition: background-color 0.2s ease;
        }
        .calendar-day:hover { background-color: #f9fafb; }
        .calendar-day.empty { background-color: #f9fafb; cursor: default; }
        .calendar-day.today { background-color: #fdfdea; }
        .calendar-day.selected { background-color: #e0e7ff; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05); }
        .calendar-day.has-trip::after {
            content: ''; position: absolute; bottom: 6px; left: 50%;
            transform: translateX(-50%); width: 6px; height: 6px;
            border-radius: 50%; background-color: #4f46e5;
        }
        
        /* Suggestion Modal Styles */
        .suggestion-item {
            display: flex; align-items: center; padding: 0.75rem; border-radius: 0.5rem;
            background-color: #f9fafb; border: 1px solid #e5e7eb; transition: background-color 0.2s ease;
        }
        .suggestion-item:hover { background-color: #f3f4f6; }
        .suggestion-item input { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header (不變) -->
    <header class="header-nav-style sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAOVBMVEX///8AAADa2trf39/g4ODd3d3b29vY2NjX19e/v7/y8vLz8/Pj4+Ph4eHu7u729vb5+fna2tqUlJSXl5eOj4qWIAU/AAABPUlEQVR4nO3PMRKAIBADAUH8/6ELCqQDIqF3j9W2rdt2v38A9DlfAQEJSEACEnBAAhKQAAScgAQkIAEJSEACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAQhIAAJyQAISEAACEpCAAgcQkIAEJSEACEvB/4gA9QyXf97GlQAAAAABJRU5ErkJggg==" alt="logo" class="h-8 w-8">
                    <div>
                        <h1 class="text-lg font-bold tracking-tight">nose.h.k</h1> 
                        <p class="text-xs text-gray-500">Sensory Discovery</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-sm font-medium flex-shrink-0">
                    <a href="https://forms.gle/Fz9KQkVYynCBQgfm7" target="_blank" class="py-2 px-4 rounded-lg hover:bg-gray-100/80">
                        <span class="sm:hidden">登記</span>
                        <span class="hidden sm:inline">小店/活動登記</span>
                    </a>
                    <div id="auth-container" class="flex items-center gap-2 text-sm font-medium"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div id="page-container">
        <!-- Explore Page (HTML 結構不變) -->
        <main id="explore-page" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <section id="filters" class="bg-white p-6 rounded-2xl shadow-lg shadow-gray-500/5 mb-8 border border-gray-200/50">
                <h2 class="text-xl font-bold mb-1 tracking-tight">Discover by senses —</h2>
                <p class="text-gray-500 mb-5">Pick one or more senses and explore Events & Local Shops curated for you.</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <div id="senses-container" class="flex flex-wrap gap-2 items-center"></div>
                    <div class="flex-grow flex flex-col sm:flex-row gap-3 mt-2 sm:mt-0">
                        <select id="district-select" class="w-full sm:w-40 p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-gray-400 focus:border-gray-400 outline-none">
                            <option value="all">所有地區</option>
                        </select>
                        <input type="text" id="search-input" placeholder="搜尋活動或小店..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-gray-400 outline-none">
                    </div>
                </div>
            </section>
            
            <section id="results-container">
                <div class="mb-4">
                    <div class="flex items-center gap-2 text-sm font-medium border-b border-gray-200">
                        <button data-filter="events" class="filter-btn active py-3 px-5">活動</button>
                        <button data-filter="places" class="filter-btn py-3 px-5">本地小店</button>
                    </div>
                </div>
                <div id="date-scroller" class="mb-6 -mt-2 pb-2 overflow-x-auto whitespace-nowrap"></div>
                <p id="results-count" class="text-sm text-gray-500 mb-4"></p>
                <div id="loader" class="text-center py-10"><p class="text-gray-500">正在加載體驗...</p></div>
                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="no-results" class="hidden text-center py-16">
                    <p class="text-lg text-gray-600">找不到任何體驗。</p>
                    <p class="text-gray-500">請嘗試調整你的篩選條件。</p>
                </div>
            </section>
        </main>
        
        <!-- Planner Page (HTML 結構已更新) -->
        <main id="planner-page" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 py-8">
             <!-- JS 會喺呢度填入日曆或登入提示 -->
        </main>

    </div>

    <!-- Bottom Tab Bar (不變) -->
    <nav class="bottom-nav-style fixed bottom-0 left-0 right-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-around">
            <button data-page="explore-page" class="tab-btn active flex-1 flex flex-col items-center justify-center py-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M9.69 2.522a.75.75 0 01.62 0l6.25 2.5a.75.75 0 01.44 1.012l-2.5 6.25a.75.75 0 01-1.012.44l-6.25-2.5a.75.75 0 01-.44-1.012l2.5-6.25a.75.75 0 011.012-.44zM8.5 9.75a.75.75 0 00-1.06-1.06l-1.5 1.5a.75.75 0 001.06 1.06l1.5-1.5zm2.56-1.06a.75.75 0 011.06 0l1.5 1.5a.75.75 0 01-1.06 1.06l-1.5-1.5a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg>
                <span class="text-xs font-medium">探索</span>
            </button>
            <button data-page="planner-page" class="tab-btn flex-1 flex flex-col items-center justify-center py-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path d="M5.5 16.5a1.5 1.5 0 01-1.5-1.5V5A1.5 1.5 0 015.5 3.5h9A1.5 1.5 0 0116 5v10a1.5 1.5 0 01-1.5 1.5h-9zM7 6a1 1 0 00-1 1v1a1 1 0 001 1h6a1 1 0 001-1V7a1 1 0 00-1-1H7z" /></svg>
                <span class="text-xs font-medium">我的行程</span>
            </button>
        </div>
    </nav>
	
    <!-- 原本的詳情 Modal (z-index: 30) (不變) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 hidden z-30 modal-enter">
        <div id="modal-content" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl bg-white rounded-2xl shadow-xl p-4 sm:p-6 modal-content-transform"></div>
    </div>

    <!-- 建議彈窗 (z-index: 40) (HTML 結構不變) -->
    <div id="suggestion-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden z-40 modal-enter">
        <div id="suggestion-modal-content" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-lg bg-white rounded-2xl shadow-xl p-6 modal-content-transform">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">建立你的行程</h3>
                <button id="suggestion-modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                </button>
            </div>
            <div id="suggestion-primary-item" class="mb-4"></div>
            <h4 id="suggestion-title" class="text-md font-semibold text-gray-700 mb-2"></h4>
            <div id="suggestion-list" class="max-h-48 overflow-y-auto space-y-2 mb-6 pr-2"></div>
            <button id="suggestion-confirm-btn" class="w-full bg-gray-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors">確認並建立行程</button>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, arrayUnion, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; 
	
        // Firebase Config (不變)
        const firebaseConfig = {
            apiKey: "AIzaSyBHw_5ApaAa6N18ym4QnzJwmoxWRP3M4Ac",
            authDomain: "nostartnoendhk-11a6a.firebaseapp.com",
            projectId: "nostartnoendhk-11a6a",
            storageBucket: "nostartnoendhk-11a6a.appspot.com",
            messagingSenderId: "1394470229",
            appId: "1:1394470229:web:e20dd66a469aaaf429d3dc",
            measurementId: "G-733PSHDR5L"
		};
		
        let app; let auth; let db;
        try {
            app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Firebase initialization error:", e);
            document.body.innerHTML = `<p style="color: red; padding: 20px;">Error initializing Firebase.</p>`;
        }

        const SENSES = ['Eye', 'Ear', 'Nose', 'Tongue', 'Body', 'Mind'];
        const SENSES_ZH = ['眼', '耳', '鼻', '舌', '身', '意'];

        let allPlaces = []; let allEvents = []; let userTrips = [];
        let currentFilter = 'events'; let selectedDate = 'all'; 

        // New state variables
        let currentSuggestionItem = null; let calendarMonth = new Date(); let selectedCalendarDate = null;

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const sensesContainer = document.getElementById('senses-container');
        const districtSelect = document.getElementById('district-select');
        const searchInput = document.getElementById('search-input');
        const resultsGrid = document.getElementById('results-grid');
        const loader = document.getElementById('loader');
        const noResults = document.getElementById('no-results');
        const resultsCount = document.getElementById('results-count');
        const resultFilterButtons = document.querySelectorAll('.filter-btn');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const tabButtons = document.querySelectorAll('.tab-btn[data-page]');
        const explorePage = document.getElementById('explore-page');
        const plannerPage = document.getElementById('planner-page');
        const dateScroller = document.getElementById('date-scroller');
        const suggestionModalBackdrop = document.getElementById('suggestion-modal-backdrop');
        const suggestionModalContent = document.getElementById('suggestion-modal-content');
        const suggestionPrimaryItem = document.getElementById('suggestion-primary-item');
        const suggestionTitle = document.getElementById('suggestion-title');
        const suggestionList = document.getElementById('suggestion-list');
        const suggestionConfirmBtn = document.getElementById('suggestion-confirm-btn');
        const suggestionModalCloseBtn = document.getElementById('suggestion-modal-close-btn');

        // --- PAGE NAVIGATION ---
        function showPage(pageId) {
            explorePage.classList.add('hidden');
            plannerPage.classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');
            tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });
            if (pageId === 'planner-page' && auth) {
                renderPlannerPage(auth.currentUser); // Render calendar when page is shown
            }
        }

        // --- AUTHENTICATION ---
        const provider = new GoogleAuthProvider();
        function handleSignIn() {
            if (!auth) { console.error("Auth not initialized."); return; }
            signInWithPopup(auth, provider).catch(error => console.error("Sign in error:", error));
        }
        function handleSignOut() {
            if (!auth) { console.error("Auth not initialized."); return; }
            signOut(auth).catch(error => console.error("Sign out error:", error));
        }
        if (auth) {
             onAuthStateChanged(auth, user => {
                renderAuthUI(user);
                renderPlannerPage(user); // Re-render planner on auth change
                if (user && db) { 
                    fetchUserTrips(user.uid);
                } else {
                    userTrips = [];
                    if (!plannerPage.classList.contains('hidden')) {
                        renderPlannerPage(null); // Show login prompt if on planner page
                    }
                }
             });
        }
        function renderAuthUI(user) {
            authContainer.innerHTML = '';
            if (user) {
                authContainer.innerHTML = `
                    <img src="${user.photoURL}" alt="${user.displayName}" class="w-8 h-8 rounded-full">
                    <button id="logout-btn" class="py-2 px-4 rounded-lg hover:bg-gray-100/80 transition-colors">登出</button>`;
                document.getElementById('logout-btn')?.addEventListener('click', handleSignOut);
            } else {
                authContainer.innerHTML = `<button id="login-btn" class="bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors">Google 登入</button>`;
                document.getElementById('login-btn')?.addEventListener('click', handleSignIn);
            }
        }

        // --- TRIP PLANNER LOGIC ---

        // ▼▼▼ `renderPlannerPage` 已更新 ▼▼▼
        function renderPlannerPage(user) {
            if (!user) {
                plannerPage.innerHTML = `
                    <div class="text-center py-16">
                        <h2 class="text-2xl font-bold mb-2">我的行程</h2>
                        <p class="text-gray-600 mb-4">請先登入以查看或建立你的行程。</p>
                        <button id="planner-login-btn" class="bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors">Google 登入</button>
                    </div>`;
                document.getElementById('planner-login-btn')?.addEventListener('click', handleSignIn);
            } else {
                plannerPage.innerHTML = `
                    <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg shadow-gray-500/5 border border-gray-200/50 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-lg hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 010 1.06L9.06 10l3.73 3.71a.75.75 0 11-1.06 1.06l-4.25-4.25a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 0z" clip-rule="evenodd" /></svg></button>
                            <h2 id="calendar-month-year" class="text-lg font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-lg hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 010-1.06L10.94 10 7.21 6.29a.75.75 0 111.06-1.06l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06 0z" clip-rule="evenodd" /></svg></button>
                        </div>
                        <div class="calendar-grid mb-1">
                            <div class="calendar-day-name">日</div> <div class="calendar-day-name">一</div> <div class="calendar-day-name">二</div>
                            <div class="calendar-day-name">三</div> <div class="calendar-day-name">四</div> <div class="calendar-day-name">五</div>
                            <div class="calendar-day-name">六</div>
                        </div>
                        <div id="calendar-days-grid" class="calendar-grid"></div>
                    </div>
                    <div id="selected-day-trips" class="mb-6">
                        <h3 class="text-xl font-bold mb-3">已選日期行程</h3>
                        <div id="selected-day-trips-list"><p class="text-gray-500 text-center">請點擊日曆上有標記嘅日期去睇你嘅行程。</p></div>
                    </div>
                    <div id="wishlist-places" class="mb-6">
                        <h3 class="text-xl font-bold mb-3">心水地點 (未定日期)</h3>
                        <div id="wishlist-places-list" class="space-y-3"><p class="text-gray-500 text-center">暫時冇未定日期嘅心水地點。</p></div>
                    </div>`;
                
                renderCalendar(); 
                renderWishlistPlaces(); 
                
                document.getElementById('prev-month-btn')?.addEventListener('click', () => changeMonth(-1));
                document.getElementById('next-month-btn')?.addEventListener('click', () => changeMonth(1));
            }
        }
        // ▲▲▲ `renderPlannerPage` 結束 ▲▲▲

        // ▼▼▼ 新函數 ▼▼▼
        function changeMonth(delta) {
            calendarMonth.setMonth(calendarMonth.getMonth() + delta);
            renderCalendar();
            renderWishlistPlaces(); // Ensure wishlist also renders if needed (though it shouldn't change with month)
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-days-grid');
            if (!grid) return; 

            grid.innerHTML = ''; 
            const selectedTripsContainer = document.getElementById('selected-day-trips-list');
             if(selectedTripsContainer) selectedTripsContainer.innerHTML = '<p class="text-gray-500 text-center">請點擊日曆上有標記嘅日期去睇你嘅行程。</p>';
            selectedCalendarDate = null; 

            const today = new Date(); today.setHours(0, 0, 0, 0);
            const month = calendarMonth.getMonth(); const year = calendarMonth.getFullYear();
            document.getElementById('calendar-month-year').textContent = `${year}年 ${month + 1}月`;

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); 

            // Fill empty cells
            for (let i = 0; i < startDayOfWeek; i++) { grid.innerHTML += `<div class="calendar-day empty"></div>`; }

            // Check which days have trips
            const tripDatesInMonth = new Set();
            userTrips.forEach(trip => {
                const tripDate = parseFirestoreDate(trip.tripDate);
                if (tripDate && tripDate.getFullYear() === year && tripDate.getMonth() === month) {
                    tripDatesInMonth.add(tripDate.getDate());
                }
            });

            // Fill date cells
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                let classes = 'calendar-day';
                if (date.getTime() === today.getTime()) classes += ' today';
                if (tripDatesInMonth.has(day)) classes += ' has-trip';
                grid.innerHTML += `<div class="${classes}" data-date="${dateString}">${day}</div>`;
            }
            
            // Add click listeners
            grid.querySelectorAll('.calendar-day:not(.empty)').forEach(cell => {
                cell.addEventListener('click', () => {
                    const dateStr = cell.dataset.date;
                    grid.querySelectorAll('.calendar-day').forEach(c => c.classList.remove('selected'));
                    cell.classList.add('selected');
                    selectedCalendarDate = dateStr;
                    renderSelectedDayTrips(dateStr);
                });
            });
        }

        function renderSelectedDayTrips(dateString) {
            const container = document.getElementById('selected-day-trips-list'); // Corrected ID
             if (!container) return; // Add check
            const selectedDateObj = new Date(dateString);

            const tripsForDay = userTrips.filter(trip => {
                const tripDate = parseFirestoreDate(trip.tripDate);
                return tripDate && tripDate.getTime() === selectedDateObj.getTime();
            });

            if (tripsForDay.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center">呢一日冇行程。</p>`; return;
            }
            
            container.innerHTML = tripsForDay.map(trip => `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-4 fade-in">
                    <h3 class="text-xl font-bold mb-3">${trip.name}</h3>
                    <div class="space-y-3">
                        ${trip.items.map(item => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div><p class="font-semibold">${item.name || item.title}</p><p class="text-sm text-gray-500">${item.category}</p></div>
                                <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="text-sm text-indigo-600 hover:text-indigo-800">查看</a>
                            </div>`).join('')}
                    </div>
                </div>`).join('');
        }
        
        // ▼▼▼ 新函數 ▼▼▼
        function renderWishlistPlaces() {
            const container = document.getElementById('wishlist-places-list');
            if (!container) return; 

            const wishlistTrips = userTrips.filter(trip => !trip.tripDate);

            if (wishlistTrips.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center">暫時冇未定日期嘅心水地點。</p>`; return;
            }

            container.innerHTML = wishlistTrips.map(trip => `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 fade-in">
                    <h4 class="font-semibold mb-2">${trip.name}</h4>
                    <div class="space-y-2">
                        ${trip.items.map(item => `
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <div><p class="text-sm font-medium">${item.name || item.title}</p><p class="text-xs text-gray-500">${item.category}</p></div>
                                <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="text-xs text-indigo-600 hover:text-indigo-800">查看</a>
                            </div>`).join('')}
                    </div>
                </div>`).join('');
        }
        // ▲▲▲ 新函數結束 ▲▲▲

        // ▼▼▼ `fetchUserTrips` 已更新 ▼▼▼
        function fetchUserTrips(userId) {
            if (!db) return;
            const q = query(collection(db, "trips"), where("userId", "==", userId));
            
            onSnapshot(q, (snapshot) => {
                userTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Update UI only if on the planner page
                if (!plannerPage.classList.contains('hidden')) {
                    renderCalendar(); 
                    renderWishlistPlaces(); 
                    if (selectedCalendarDate) {
                        renderSelectedDayTrips(selectedCalendarDate);
                    }
                }
            }, (error) => { console.error("Error fetching user trips: ", error); });
        }
        // ▲▲▲ `fetchUserTrips` 結束 ▲▲▲

        // ▼▼▼ `handleAddToTrip` 已更新 ▼▼▼
        function handleAddToTrip(item) {
            const user = auth?.currentUser;
            if (!user) {
                alert("請先登入，才能規劃行程。"); 
                handleSignIn();
                return;
            }
            currentSuggestionItem = item; 
            openSuggestionModal(item);   
        }
        // ▲▲▲ `handleAddToTrip` 結束 ▲▲▲

        // ▼▼▼ `openSuggestionModal` 已更新 ▼▼▼
        async function openSuggestionModal(item) {
            const isEvent = 'title' in item;
            const district = item.district;
            
            suggestionPrimaryItem.innerHTML = ''; suggestionList.innerHTML = ''; suggestionTitle.textContent = '';
            const oldDatePicker = suggestionModalContent.querySelector('#trip-date-picker');
            if (oldDatePicker) oldDatePicker.remove();

            suggestionPrimaryItem.innerHTML = `
                <p class="text-sm text-gray-500">你嘅主要項目：</p>
                <div class="suggestion-item !bg-blue-50 !border-blue-200">
                    <input type="checkbox" checked disabled>
                    <div><p class="font-semibold">${item.name || item.title}</p><p class="text-sm text-gray-600">${item.category} • ${item.district || '未知地區'}</p></div>
                </div>`;

            let potentialTripDate = null;
            let requiresDateSelection = false;

            if (isEvent) {
                const startDate = parseFirestoreDate(item.start_date);
                const endDate = parseFirestoreDate(item.end_date);
                
                if (startDate && endDate && startDate.getTime() !== endDate.getTime()) {
                    requiresDateSelection = true;
                    let dateOptionsHtml = `<div id="trip-date-picker" class="mb-4">
                        <label for="event-date-select" class="block text-sm font-medium text-gray-700 mb-1">請選擇行程日期：</label>
                        <select id="event-date-select" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500">`;
                    let currentDate = new Date(startDate);
                    while (currentDate <= endDate) {
                        const dateString = currentDate.toISOString().split('T')[0];
                        dateOptionsHtml += `<option value="${dateString}">${dateString}</option>`;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    dateOptionsHtml += `</select></div>`;
                    suggestionPrimaryItem.insertAdjacentHTML('afterend', dateOptionsHtml);
                    potentialTripDate = startDate; 
                } else if (startDate) {
                    potentialTripDate = startDate;
                } else { potentialTripDate = new Date(); }
            } else {
                requiresDateSelection = true; 
                let dateOptionsHtml = `<div id="trip-date-picker" class="mb-4">
                    <label for="place-date-select" class="block text-sm font-medium text-gray-700 mb-1">選擇行程日期 (或稍後決定)：</label>
                    <select id="place-date-select" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="later">稍後決定日期</option>`;
                const todayForPicker = new Date();
                for (let i = 0; i < 7; i++) {
                    const date = new Date(todayForPicker); date.setDate(todayForPicker.getDate() + i);
                    const dateString = date.toISOString().split('T')[0];
                    dateOptionsHtml += `<option value="${dateString}">${dateString} ${i === 0 ? '(今日)' : ''}</option>`;
                }
                dateOptionsHtml += `</select></div>`;
                suggestionPrimaryItem.insertAdjacentHTML('afterend', dateOptionsHtml);
                potentialTripDate = null; 
            }

            let suggestions = [];
            const todayForSuggestions = new Date(); todayForSuggestions.setHours(0,0,0,0);
            if (isEvent) {
                suggestionTitle.textContent = '喺「' + district + '」附近嘅小店建議：';
                suggestions = allPlaces.filter(place => place.district === district && place.id !== item.id);
            } else {
                suggestionTitle.textContent = '喺「' + district + '」附近嘅活動建議：';
                suggestions = allEvents.filter(event => {
                    const eventEnd = parseFirestoreDate(event.end_date);
                    return event.district === district && event.id !== item.id && eventEnd && eventEnd >= todayForSuggestions;
                });
            }

            if (suggestions.length > 0) {
                suggestionList.innerHTML = suggestions.slice(0, 5).map(sug => `
                    <label class="suggestion-item cursor-pointer">
                        <input type="checkbox" name="suggestion" value="${sug.id}" data-type="${'title' in sug ? 'event' : 'place'}">
                        <div><p class="font-semibold">${sug.name || sug.title}</p><p class="text-sm text-gray-600">${sug.category}</p></div>
                    </label>`).join('');
            } else {
                suggestionList.innerHTML = `<p class="text-sm text-gray-500 text-center p-4">喺呢個地區暫時冇其他建議。</p>`;
            }

            suggestionModalBackdrop.classList.remove('hidden');
            setTimeout(() => suggestionModalBackdrop.classList.remove('modal-enter'), 10);
        }
        // ▲▲▲ `openSuggestionModal` 結束 ▲▲▲

        // ▼▼▼ 新函數 ▼▼▼
        function closeSuggestionModal() {
            suggestionModalBackdrop.classList.add('modal-enter');
            setTimeout(() => suggestionModalBackdrop.classList.add('hidden'), 300);
        }
        // ▲▲▲ 新函數結束 ▲▲▲

        // ▼▼▼ `handleSuggestionConfirm` 已更新 ▼▼▼
        async function handleSuggestionConfirm() {
            const user = auth?.currentUser;
            if (!user || !currentSuggestionItem) return;

            let tripItems = [];
            tripItems.push(formatItemForTrip(currentSuggestionItem)); 
            const checkedBoxes = suggestionList.querySelectorAll('input[name="suggestion"]:checked');
            checkedBoxes.forEach(box => {
                const id = box.value; const type = box.dataset.type;
                const sourceArray = (type === 'event') ? allEvents : allPlaces;
                const suggestion = sourceArray.find(item => item.id === id);
                if (suggestion) { tripItems.push(formatItemForTrip(suggestion)); }
            });

            const primaryItem = currentSuggestionItem;
            const isEvent = 'title' in primaryItem;
            let tripName = ""; let tripDate = null; 

            const datePicker = suggestionModalContent.querySelector('#event-date-select, #place-date-select');
            let selectedDateValue = null;
            if (datePicker) { selectedDateValue = datePicker.value; }

            if (isEvent) {
                tripName = primaryItem.title;
                const startDate = parseFirestoreDate(primaryItem.start_date);
                const endDate = parseFirestoreDate(primaryItem.end_date);

                if (startDate && endDate && startDate.getTime() !== endDate.getTime()) {
                    if (selectedDateValue) { tripDate = new Date(selectedDateValue); } 
                    else { tripDate = startDate || new Date(); }
                } else {
                    tripDate = startDate || new Date();
                }
            } else {
                tripName = `我嘅 ${primaryItem.name} 之旅`;
                if (selectedDateValue && selectedDateValue !== 'later') {
                    tripDate = new Date(selectedDateValue);
                } 
            }
            
            if (tripDate) { tripDate.setHours(0, 0, 0, 0); }

            const tripData = {
                userId: user.uid, name: tripName, createdAt: Timestamp.now(), items: tripItems,
                ...(tripDate && { tripDate: Timestamp.fromDate(tripDate) }) 
            };

            try {
                await addDoc(collection(db, "trips"), tripData); 
                console.log("New trip created!", tripData);
                closeSuggestionModal(); closeModal(); 
                alert("行程已成功建立！");
                showPage('planner-page'); 
            } catch (e) {
                console.error("Error creating new trip: ", e);
                alert("建立行程時發生錯誤，請稍後再試。");
            }
        }
        // ▲▲▲ `handleSuggestionConfirm` 結束 ▲▲▲

        // ▼▼▼ 新函數 ▼▼▼
        function formatItemForTrip(item) {
            return {
                id: item.id || null, name: item.name || item.title, category: item.category,
                url: item.url, district: item.district, address: item.address || null
            };
        }
        // ▲▲▲ 新函數結束 ▲▲▲
        
        // --- DATA FETCHING & RENDERING (其他函數不變) ---
        function parseFirestoreDate(dateField) { // Keep the robust parsing
            if (!dateField) return null;
            if (typeof dateField.toDate === 'function') return dateField.toDate();
            if (dateField instanceof Date) return dateField;
            if (typeof dateField === 'string') {
                const d = new Date(dateField); if (!isNaN(d.getTime())) return d;
                const parts = dateField.split('-');
                if (parts.length === 3) {
                    const date = new Date(parts[0], parseInt(parts[1]) - 1, parseInt(parts[2]));
                     if (!isNaN(date.getTime())) return date;
                }
            }
            console.warn("Could not parse date:", dateField); return null;
        }
        function fetchData() { /* ... 不變 ... */ 
            if (!db) { console.error("DB not init"); loader.style.display = 'none'; return; }
            loader.style.display = 'block';
            const handleSnapshot = (snapshot, type) => {
                const dataArray = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (type === 'places') allPlaces = dataArray; else allEvents = dataArray;
                populateDistricts(); performSearch();
            };
            const handleError = (type, error) => {
                console.error(`Error fetching ${type}:`, error); loader.style.display = 'none';
                if (!resultsGrid.querySelector('.text-red-500')) resultsGrid.innerHTML = `<p class="text-red-500 col-span-full text-center">無法載入資料</p>`;
            };
            try {
                onSnapshot(collection(db, "places"), (snap) => handleSnapshot(snap, 'places'), (err) => handleError('places', err));
                onSnapshot(collection(db, "events"), (snap) => handleSnapshot(snap, 'events'), (err) => handleError('events', err));
            } catch(e) { console.error("Error listeners:", e); handleError("data", e); }
        }
        function stringToColor(str) { /* ... 不變 ... */ 
            if (!str) return '#cccccc'; let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            let color = '#';
            for (let i = 0; i < 3; i++) { let value = (hash >> (i * 8)) & 0xFF; color += ('00' + value.toString(16)).substr(-2); }
            return color;
        }
        function populateSenses() { /* ... 不變 ... */ 
            sensesContainer.innerHTML = SENSES.map((sense, index) => `<button data-sense="${sense}" class="sense-btn border px-3 py-1.5 rounded-lg text-sm font-medium">${SENSES_ZH[index]}</button>`).join('');
            sensesContainer.addEventListener('click', e => { if (e.target.classList.contains('sense-btn')) { e.target.classList.toggle('active'); performSearch(); } });
        }
        function populateDistricts() { /* ... 不變 ... */ 
            const currentSelection = districtSelect.value;
            const districts = [...new Set([...allPlaces.map(p => p.district), ...allEvents.map(e => e.district)])].filter(Boolean).sort();
            districtSelect.innerHTML = `<option value="all">所有地區</option>` + districts.map(d => `<option value="${d}">${d}</option>`).join('');
            districtSelect.value = currentSelection;
        }
        function populateDateScroller() { /* ... 不變 ... */ 
            let buttonsHtml = `<button class="date-btn active" data-date="all">所有日子</button>`;
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            for (let i = 0; i < 6; i++) {
                const date = new Date(); date.setDate(date.getDate() + i);
                const dateString = date.toISOString().split('T')[0]; const day = date.getDate(); const weekday = weekdays[date.getDay()];
                buttonsHtml += `<button class="date-btn" data-date="${dateString}">${day} (${weekday})</button>`;
            }
            dateScroller.innerHTML = buttonsHtml;
        }
        function performSearch() { /* ... 包含上次修正 ... */ 
            const selectedSenses = Array.from(sensesContainer.querySelectorAll('.sense-btn.active')).map(btn => btn.dataset.sense);
            const selectedDistrict = districtSelect.value; const searchQuery = searchInput.value.toLowerCase();
            const isEventMode = currentFilter === 'events'; let sourceData = isEventMode ? allEvents : allPlaces;

            const filtered = sourceData.filter(item => {
                const name = item.name || item.title; if (!name) return false; 
                const districtMatch = selectedDistrict === 'all' || item.district === selectedDistrict;
                const senses = item.senses || item.selected_senses || '';
                const sensesMatch = selectedSenses.length === 0 || selectedSenses.every(s => senses.includes(s));
                const searchMatch = searchQuery === '' || name.toLowerCase().includes(searchQuery);
                if (!districtMatch || !sensesMatch || !searchMatch) return false;
                if (isEventMode) {
                    const today = new Date(); today.setHours(0, 0, 0, 0); const eventEnd = parseFirestoreDate(item.end_date);
                    if (eventEnd && eventEnd < today) return false;
                    if (selectedDate !== 'all') {
                        const filterDate = new Date(selectedDate); filterDate.setHours(0, 0, 0, 0); 
                        const eventStart = parseFirestoreDate(item.start_date);
                        if (!eventStart) return false; eventStart.setHours(0, 0, 0, 0); 
                        if (eventStart < filterDate) return false;
                    }
                } return true;
            });
            filtered.sort((a, b) => {
                if (isEventMode) { const dateA = parseFirestoreDate(a.start_date)?.getTime() || Infinity; const dateB = parseFirestoreDate(b.start_date)?.getTime() || Infinity; return dateA - dateB; } 
                else { const dateA = parseFirestoreDate(a.created_at)?.getTime() || 0; const dateB = parseFirestoreDate(b.created_at)?.getTime() || 0; return dateB - dateA; }
            }); renderResults(filtered);
        }
        function renderResults(results) { /* ... 不變, 但 add-to-trip 監聽器已更新 ... */ 
            resultsGrid.innerHTML = ''; resultsCount.textContent = `顯示 ${results.length} 個結果`;
            loader.style.display = 'none'; noResults.style.display = results.length === 0 ? 'block' : 'none';
            results.forEach((item, index) => {
                const isEvent = 'title' in item; const name = item.name || item.title;
                const senses = (item.senses || item.selected_senses || '').split(',').map(s => s.trim()).filter(Boolean);
                const color = stringToColor(name).substring(1); const placeholderImgUrl = `https://placehold.co/600x400/${color}/FFFFFF?text=${encodeURIComponent(name.charAt(0))}&font=raleway`;
                const card = document.createElement('div'); card.className = 'result-card rounded-xl overflow-hidden flex flex-col fade-in'; card.style.animationDelay = `${index * 50}ms`;
                card.innerHTML = `
                    <div class="aspect-video bg-gray-100"><img src="${placeholderImgUrl}" alt="${name}" class="w-full h-full object-cover"></div>
                    <div class="p-4 flex flex-col flex-grow">
                        <p class="text-xs font-semibold text-gray-500">${item.category || (isEvent ? '活動' : '地點')}</p>
                        <h3 class="font-bold text-lg mt-1 tracking-tight">${name}</h3>
                        <p class="text-sm text-gray-500">${item.address || item.district}</p>
                        <div class="mt-3 pt-3 border-t border-gray-100 flex flex-wrap gap-1.5">${senses.map(s => `<span class="bg-gray-100 text-gray-700 text-xs font-medium px-2 py-1 rounded-full">${s}</span>`).join('')}</div>
                        <div class="mt-auto pt-4 flex gap-2">
                            <button class="view-details-btn w-full bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200">${isEvent ? '查看活動' : '查看小店'}</button>
                            <button title="加入心水行程" class="add-to-trip-btn flex-shrink-0 bg-gray-100 text-gray-600 p-2 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                            </button>
                        </div>
                    </div>`;
                card.querySelector('.view-details-btn').addEventListener('click', () => openModal(item));
                card.querySelector('.add-to-trip-btn').addEventListener('click', (e) => { e.stopPropagation(); handleAddToTrip(item); }); // Use new handler
                resultsGrid.appendChild(card);
            });
        }
        function openModal(item) { /* ... 不變, 但 add-to-trip 監聽器已更新 ... */ 
            const isEvent = 'title' in item; const name = item.name || item.title;
            const senses = (item.senses || item.selected_senses || '').split(',').map(s => s.trim()).filter(Boolean);
            const color = stringToColor(name).substring(1); const placeholderImgUrl = `https://placehold.co/800x400/${color}/FFFFFF?text=${encodeURIComponent(name)}&font=raleway`;
            let eventDateStr = '';
            if (isEvent) { let startDate = parseFirestoreDate(item.start_date)?.toLocaleDateString('zh-HK') || ''; let endDate = parseFirestoreDate(item.end_date)?.toLocaleDateString('zh-HK') || ''; eventDateStr = `<p class="text-sm text-blue-600 font-semibold mt-2">${startDate}${endDate && endDate !== startDate ? ' - ' + endDate : ''}</p>`; }
            modalContent.innerHTML = `
                <div class="relative">
                    <button id="modal-close-btn" class="absolute -top-2 -right-2 sm:-top-4 sm:-right-4 bg-white rounded-full p-1.5 shadow-md hover:bg-gray-100 transition-colors z-10"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg></button>
                    <div class="w-full aspect-video bg-gray-100 rounded-lg overflow-hidden mb-4"><img src="${placeholderImgUrl}" alt="${name}" class="w-full h-full object-cover"></div>
                    <h3 class="font-bold text-xl sm:text-2xl tracking-tight">${name}</h3>
                    <p class="text-gray-500 mt-1">${item.address || item.district}</p>
                    ${eventDateStr}
                    <div class="mt-4 pt-4 border-t flex flex-wrap gap-2">${senses.map(s => `<span class="bg-gray-100 text-gray-700 text-xs font-medium px-2 py-1 rounded-full">${s}</span>`).join('')}</div>
                    <p class="text-gray-600 mt-4">${item.description || '暫無描述。'}</p>
                    <div class="mt-6 flex gap-2">
                        <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="fancy-btn block w-full text-center font-bold py-3 px-6 rounded-lg">${isEvent ? '前往活動網站' : '前往小店網站'}</a>
                        <button title="加入心水行程" id="modal-add-to-trip-btn" class="add-to-trip-btn flex-shrink-0 bg-gray-100 text-gray-600 p-3 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                        </button>
                    </div>
                </div>`;
            modalBackdrop.classList.remove('hidden'); setTimeout(() => modalBackdrop.classList.remove('modal-enter'), 10);
            document.getElementById('modal-close-btn')?.addEventListener('click', closeModal);
            document.getElementById('modal-add-to-trip-btn')?.addEventListener('click', (e) => { handleAddToTrip(item); }); // Use new handler
        }
        function closeModal() { /* ... 不變 ... */ 
             modalBackdrop.classList.add('modal-enter'); setTimeout(() => modalBackdrop.classList.add('hidden'), 300);
        }

        // --- EVENT LISTENERS ---
        districtSelect?.addEventListener('change', performSearch);
        searchInput?.addEventListener('input', performSearch);
        resultFilterButtons.forEach(button => {
            button.addEventListener('click', () => {
                resultFilterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active'); currentFilter = button.dataset.filter;
                dateScroller.classList.toggle('hidden', currentFilter !== 'events');
                selectedDate = 'all'; 
                dateScroller.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
                dateScroller.querySelector('.date-btn[data-date="all"]')?.classList.add('active'); // Add null check
                performSearch();
            });
        });
        modalBackdrop?.addEventListener('click', e => { if (e.target === modalBackdrop) closeModal(); });
        tabButtons.forEach(button => { button.addEventListener('click', () => { showPage(button.dataset.page); }); });
        dateScroller?.addEventListener('click', e => {
            const target = e.target.closest('.date-btn'); if (!target) return;
            dateScroller.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active'); selectedDate = target.dataset.date; performSearch();
        });
        // New listeners for suggestion modal
        suggestionModalCloseBtn?.addEventListener('click', closeSuggestionModal);
        suggestionModalBackdrop?.addEventListener('click', e => { if (e.target === suggestionModalBackdrop) closeSuggestionModal(); });
        suggestionConfirmBtn?.addEventListener('click', handleSuggestionConfirm);

        // --- INITIALIZATION ---
        if (db && auth) {
            populateSenses(); populateDateScroller(); fetchData(); showPage('explore-page'); 
        } else { console.log("Firebase not ready, skipping init."); }
    </script>
</body>
</html>
