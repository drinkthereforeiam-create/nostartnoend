<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nose.h.k | sensory discovery</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" href="public/icon.png" type="image/png">

    <style>
        /* Base styles from new 1_update(work).html */
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; padding-bottom: 80px; /* Added padding */ }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .filter-btn.active { background-color: #343a40; color: #ffffff; }
        .sense-btn.active { background-color: #495057; color: #ffffff; border-color: #495057; }
        .result-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .result-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        #modal-backdrop { transition: opacity 0.3s ease-in-out; }
        #modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; }
        .modal-enter .modal-content-transform { transform: scale(0.95) translateY(20px); }
        .modal-enter-active .modal-content-transform { transform: scale(1) translateY(0); }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Styles from index.html */
        .tab-btn.active { color: #111827; }
        .tab-btn.active svg { color: #111827; }
        .add-to-trip-btn { transition: all 0.2s ease; }
        .add-to-trip-btn:hover { transform: scale(1.1); background-color: #e5e7eb; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header (from index.html structure) -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-20 border-b border-gray-200">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <img src="public/icon.png" alt="logo" class="h-8 w-8">
                    <div>
                        <h1 class="text-lg font-bold">nose.h.k</h1>
                        <p class="text-xs text-gray-500">Sensory Discovery</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-sm font-medium">
                    <a href="https://forms.gle/Fz9KQkVYynCBQgfm7" target="_blank" class="hidden sm:block py-2 px-4 rounded-md hover:bg-gray-100 transition-colors">
                        小店/活動登記
                    </a>
                    <div id="auth-container" class="flex items-center gap-2 text-sm font-medium">
                        <!-- Auth UI populated by JS -->
					</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area (Structure from index.html) -->
    <div id="page-container">
        <!-- Explore Page (Content mostly from new 1_update(work).html) -->
        <main id="explore-page" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <section id="filters" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8">
                <h2 class="text-xl font-bold mb-1">Discover by senses —</h2>
                <p class="text-gray-500 mb-4">Pick one or more senses and explore Events & Local Shops curated for you.</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <div id="senses-container" class="flex flex-wrap gap-2 items-center"></div>
                    <div class="flex-grow flex flex-col sm:flex-row gap-2 mt-2 sm:mt-0">
                        <select id="district-select" class="w-full sm:w-40 p-2 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-gray-400 focus:border-gray-400 outline-none">
                            <option value="all">所有地區</option>
                        </select>
                        <input type="text" id="search-input" placeholder="搜尋活動或小店..." class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-gray-400 focus:border-gray-400 outline-none">
                    </div>
                </div>
            </section>
            <section id="results-container">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2 text-sm font-medium">
                        <button data-filter="all" class="filter-btn active py-2 px-4 rounded-md bg-gray-200">全部</button>
                        <button data-filter="events" class="filter-btn py-2 px-4 rounded-md hover:bg-gray-200">活動</button>
                        <button data-filter="places" class="filter-btn py-2 px-4 rounded-md hover:bg-gray-200">本地小店</button>
                    </div>
                    <p id="results-count" class="text-sm text-gray-500"></p>
                </div>
                <div id="loader" class="text-center py-10"><p class="text-gray-500">正在加載體驗...</p></div>
                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="no-results" class="hidden text-center py-16">
                    <p class="text-lg text-gray-600">找不到任何體驗。</p>
                    <p class="text-gray-500">請嘗試調整你的篩選條件。</p>
                </div>
            </section>
        </main>
        
        <!-- Planner Page (Structure from index.html) -->
        <main id="planner-page" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Content populated by JS based on login state -->
        </main>
    </div>

    <!-- Bottom Tab Bar (from index.html) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-gray-200 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-around">
            <button data-page="explore-page" class="tab-btn active flex-1 flex flex-col items-center justify-center py-2 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M9.69 2.522a.75.75 0 01.62 0l6.25 2.5a.75.75 0 01.44 1.012l-2.5 6.25a.75.75 0 01-1.012.44l-6.25-2.5a.75.75 0 01-.44-1.012l2.5-6.25a.75.75 0 011.012-.44zM8.5 9.75a.75.75 0 00-1.06-1.06l-1.5 1.5a.75.75 0 001.06 1.06l1.5-1.5zm2.56-1.06a.75.75 0 011.06 0l1.5 1.5a.75.75 0 01-1.06 1.06l-1.5-1.5a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg>
                <span class="text-xs font-medium">探索</span>
            </button>
            <button data-page="planner-page" class="tab-btn flex-1 flex flex-col items-center justify-center py-2 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path d="M5.5 16.5a1.5 1.5 0 01-1.5-1.5V5A1.5 1.5 0 015.5 3.5h9A1.5 1.5 0 0116 5v10a1.5 1.5 0 01-1.5 1.5h-9zM7 6a1 1 0 00-1 1v1a1 1 0 001 1h6a1 1 0 001-1V7a1 1 0 00-1-1H7z" /></svg>
                <span class="text-xs font-medium">我的行程</span>
            </button>
        </div>
    </nav>
	 
    <!-- Modal (Structure from index.html) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-30 modal-enter">
        <div id="modal-content" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1.2 w-11/12 max-w-2xl bg-white rounded-2xl shadow-xl p-4 sm:p-6 modal-content-transform"></div>
    </div>
    
    <!-- Footer -->
    <footer class="text-center py-8 border-t border-gray-200">
        <p class="text-sm text-gray-500">版權所有 © 2025 nostartnoend.hk</p>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, arrayUnion, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // Added Timestamp
    
        // Firebase Config (from new 1_update(work).html - ensure this is correct)
		const firebaseConfig = {
	  	apiKey: "AIzaSyBHw_5ApaAa6N18ym4QnzJwmoxWRP3M4Ac",
	  	authDomain: "nostartnoendhk-11a6a.firebaseapp.com",
	 	projectId: "nostartnoendhk-11a6a",
	  	storageBucket: "nostartnoendhk-11a6a.appspot.com",
	  	messagingSenderId: "1394470229",
	  	appId: "1:1394470229:web:e20dd66a469aaaf429d3dc",
	  	measurementId: "G-733PSHDR5L"
		};
		
        // Initialize Firebase (with error handling)
        let app;
        let auth;
        let db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Firebase initialization error:", e);
            document.body.innerHTML = '<p style="color: red; padding: 20px;">Error initializing Firebase. Please check the console and Firebase configuration.</p>';
        }

        const SENSES = ['Eye', 'Ear', 'Nose', 'Tongue', 'Body', 'Mind'];
        const SENSES_ZH = ['眼', '耳', '鼻', '舌', '身', '意'];

        let allPlaces = [];
        let allEvents = [];
        let userTrips = [];
        let currentFilter = 'all';

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const sensesContainer = document.getElementById('senses-container');
        const districtSelect = document.getElementById('district-select');
        const searchInput = document.getElementById('search-input');
        const resultsGrid = document.getElementById('results-grid');
        const loader = document.getElementById('loader');
        const noResults = document.getElementById('no-results');
        const resultsCount = document.getElementById('results-count');
        const resultFilterButtons = document.querySelectorAll('.filter-btn');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const explorePage = document.getElementById('explore-page');
        const plannerPage = document.getElementById('planner-page');

        // --- PAGE NAVIGATION ---
        function showPage(pageId) {
            explorePage.classList.add('hidden');
            plannerPage.classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');

            tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });
            if (pageId === 'planner-page' && auth) {
                renderPlannerPage(auth.currentUser);
            }
        }

        // --- AUTHENTICATION ---
        const provider = new GoogleAuthProvider();

        function handleSignIn() {
            if (!auth) { console.error("Auth not initialized."); return; }
            signInWithPopup(auth, provider).catch(error => console.error("Sign in error:", error));
        }

        function handleSignOut() {
            if (!auth) { console.error("Auth not initialized."); return; }
            signOut(auth).catch(error => console.error("Sign out error:", error));
        }

        if (auth) {
             onAuthStateChanged(auth, user => {
                renderAuthUI(user);
                renderPlannerPage(user); // Always update planner view on auth change
                if (user && db) {
                    fetchUserTrips(user.uid);
                } else {
                    userTrips = []; // Clear trips data
                    if (document.getElementById('planner-page').classList.contains('hidden')) {
                       // Only render if planner page is active, handled by showPage now
                    } else {
                        renderPlannerPage(null); // Ensure logged-out view is shown if on planner page
                    }
                }
             });
        }

        function renderAuthUI(user) {
            authContainer.innerHTML = '';
            if (user) {
                authContainer.innerHTML = `
                    <img src="${user.photoURL}" alt="${user.displayName}" class="w-8 h-8 rounded-full">
                    <button id="logout-btn" class="py-2 px-4 rounded-md hover:bg-gray-100 transition-colors">登出</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', handleSignOut);
            } else {
                authContainer.innerHTML = `<button id="login-btn" class="bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors">Google 登入</button>`;
                document.getElementById('login-btn').addEventListener('click', handleSignIn);
            }
        }

        // --- TRIP PLANNER LOGIC (from index.html) ---
        function renderPlannerPage(user) {
            plannerPage.innerHTML = ''; // Clear previous content
            if (user) {
                 plannerPage.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">我的行程</h2>
                        <button id="create-trip-btn" class="bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700">+ 新增行程</button>
                    </div>
                    <div id="trips-container" class="space-y-6">
                        <!-- Trips will be rendered here -->
                        <p class="text-gray-500 text-center py-8">正在載入行程...</p> 
                    </div>
                `;
                renderUserTrips(); // Render based on current userTrips data
                document.getElementById('create-trip-btn').addEventListener('click', createNewTrip);
            } else {
                plannerPage.innerHTML = `
                    <div class="text-center py-16">
                        <h2 class="text-xl font-bold mb-2">登入以規劃你的專屬行程</h2>
                        <p class="text-gray-500 mb-6">儲存你喜歡的小店與活動，建立你的感官探索之旅。</p>
                        <button id="planner-login-btn" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-lg">使用 Google 登入</button>
                    </div>
                `;
                document.getElementById('planner-login-btn').addEventListener('click', handleSignIn);
            }
        }
        
        async function createNewTrip() {
            const user = auth?.currentUser;
            if (!user || !db) return;

            const tripName = prompt("請為你的新行程命名：", `我的行程 #${userTrips.length + 1}`);
            if (tripName && tripName.trim() !== "") { // Ensure name is not empty
                try {
                    console.log(`Creating new trip "${tripName}" for user ${user.uid}`);
                    await addDoc(collection(db, "trips"), {
                        userId: user.uid,
                        name: tripName.trim(),
                        items: [],
                        // Use Firestore Server Timestamp for better accuracy
                        created_at: Timestamp.now() 
                    });
                    console.log("Trip created successfully.");
                } catch (e) {
                    console.error("Error creating new trip: ", e);
                    alert("建立行程時發生錯誤，請稍後再試。");
                }
            }
        }
        
        function fetchUserTrips(userId) {
             if (!db) { console.error("DB not initialized for fetchUserTrips"); return; }
             console.log(`Fetching trips for user ${userId}`);
             const q = query(collection(db, "trips"), where("userId", "==", userId));
             
             // Setup snapshot listener
             onSnapshot(q, (snapshot) => {
                console.log(`Received ${snapshot.docs.length} trips snapshot.`);
                userTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort by Timestamp object directly if available, otherwise fallback to string/date conversion
                userTrips.sort((a, b) => {
                     const timeA = a.created_at?.toDate ? a.created_at.toDate().getTime() : (a.created_at ? new Date(a.created_at).getTime() : 0);
                     const timeB = b.created_at?.toDate ? b.created_at.toDate().getTime() : (b.created_at ? new Date(b.created_at).getTime() : 0);
                     return (isNaN(timeB)? 0 : timeB) - (isNaN(timeA)? 0 : timeA); // Handle potential NaN
                }); 
                renderUserTrips(); // Update UI whenever trips data changes
             }, (error) => {
                 console.error("Error fetching user trips:", error);
                 const container = document.getElementById('trips-container');
                 if(container) container.innerHTML = `<p class="text-red-500 text-center py-8">無法載入行程資料。</p>`;
             });
        }
        
        function renderUserTrips() {
            const container = document.getElementById('trips-container');
            // Ensure container exists AND user is logged in before rendering trips
            if (!container || !auth?.currentUser) {
                // If container exists but user logged out, renderPlannerPage handles the message.
                // If container doesn't exist (e.g., Explore page), do nothing.
                return; 
            }
             console.log(`Rendering ${userTrips.length} trips.`);

            if (userTrips.length === 0) {
                 container.innerHTML = `<p class="text-gray-500 text-center py-8">你還沒有任何行程。在「探索」頁面點擊卡片上的「+」按鈕來新增項目吧！</p>`;
                 return;
            }

            container.innerHTML = userTrips.map(trip => {
                // Ensure trip.items exists and is an array before mapping
                 const itemsHtml = Array.isArray(trip.items) && trip.items.length > 0 
                    ? trip.items.map(item => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="font-semibold">${item.name || item.title || '未知項目'}</p>
                                <p class="text-sm text-gray-500">${item.category || ''}</p>
                            </div>
                            ${item.url ? `<a href="${item.url}" target="_blank" class="text-sm font-medium text-blue-600 hover:underline">查看</a>` : ''}
                        </div>
                      `).join('') 
                    : '<p class="text-sm text-gray-400">這個行程還是空的。</p>';

                return `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">${trip.name || '未命名行程'}</h3>
                        <div class="space-y-3">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function handleAddToTrip(item) {
             const user = auth?.currentUser;
             if (!user || !db) {
                 alert("請先登入才能新增項目到行程中。");
                 return;
             }
             console.log("Attempting to add item:", item);

             if (userTrips.length === 0) {
                 const createFirst = confirm("你還沒有任何行程。要立即建立一個嗎？");
                 if (createFirst) {
                     // Need to await trip creation before potentially adding
                     await createNewTrip(); 
                     // After creation, fetchUserTrips listener will update userTrips. 
                     // We might need a slight delay or re-check before adding.
                     // For simplicity now, ask user to click again.
                     alert("行程已建立，請再次點擊 '+' 新增項目。");
                 }
                 return; 
             }
             
             // Simplified: Add to the most recent trip (first in the sorted list)
             const tripToUpdate = userTrips[0];
             if (!tripToUpdate || !tripToUpdate.id) {
                  console.error("Could not find a valid trip to add to.");
                  alert("找不到有效的行程來新增項目。");
                  return;
             }
             const tripRef = doc(db, "trips", tripToUpdate.id);

             // Prepare item data - ensure it's clean and doesn't contain undefined fields
             const itemToAdd = {
                 name: item.name || item.title || null,
                 category: item.category || null,
                 url: item.url || null,
                 // Add other relevant fields if needed, ensuring they exist in `item`
                 district: item.district || null, 
                 address: item.address || null,
                 senses: item.senses || item.selected_senses || null,
                 isEvent: 'title' in item // Add a flag to know if it's an event or place
             };
             // Remove null properties to keep Firestore data clean
             Object.keys(itemToAdd).forEach(key => itemToAdd[key] == null && delete itemToAdd[key]);


             try {
                 console.log(`Adding item to trip ${tripToUpdate.id}:`, itemToAdd);
                 await updateDoc(tripRef, {
                     // Use arrayUnion to prevent duplicates if the exact same object is added
                     items: arrayUnion(itemToAdd) 
                 });
                 console.log("Item added successfully.");
                 alert(`已將 "${itemToAdd.name}" 新增到 "${tripToUpdate.name}"！`);
             } catch (e) {
                 console.error("Error adding item to trip: ", e);
                 alert("新增項目到行程時發生錯誤。");
             }
        }

        // --- DATA FETCHING & RENDERING (Core logic mostly from new 1_update(work).html) ---
        function fetchData() { /* ... (same logic as before, ensure db check) ... */ }
        function stringToColor(str) { /* ... same ... */ }
        function populateSenses() { /* ... same ... */ }
        function populateDistricts() { /* ... same ... */ }
        function performSearch() { /* ... same filtering logic ... */ }

        // --- Render Results (Combine UI + Add to Trip Button) ---
        function renderResults(results) {
             if (!db || !auth) return; // Don't render if Firebase not ready

             results.sort((a, b) => { // Refined sorting
                 const timeA = a.created_at?.toDate ? a.created_at.toDate().getTime() : (a.created_at ? new Date(a.created_at).getTime() : 0);
                 const timeB = b.created_at?.toDate ? b.created_at.toDate().getTime() : (b.created_at ? new Date(b.created_at).getTime() : 0);
                 return (isNaN(timeB)? 0 : timeB) - (isNaN(timeA)? 0 : timeA);
             });

             resultsGrid.innerHTML = '';
             resultsCount.textContent = `顯示 ${results.length} 個結果`;
             loader.style.display = 'none';
             noResults.style.display = results.length === 0 ? 'block' : 'none';

             results.forEach((item, index) => {
                 const isEvent = 'title' in item;
                 const name = item.name || item.title;
                 if (!name) return; // Skip items without name/title

                 const senses = (item.senses || item.selected_senses || '').split(',').map(s => s.trim()).filter(Boolean);
                 const color = stringToColor(name).substring(1);
                 const placeholderImgUrl = `https://placehold.co/600x400/${color}/FFFFFF?text=${encodeURIComponent(name.charAt(0))}&font=raleway`;
                 
                 const card = document.createElement('div');
                 card.className = 'result-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col fade-in relative';
                 card.style.animationDelay = `${index * 50}ms`;
                 
                 card.innerHTML = `
                    <button class="add-to-trip-btn absolute top-2 right-2 bg-white/70 backdrop-blur-sm rounded-full p-2 z-10 ${auth.currentUser ? '' : 'hidden'}"> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-gray-600"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                    </button>
                    <div class="aspect-video bg-gray-100"><img src="${placeholderImgUrl}" alt="${name}" class="w-full h-full object-cover"></div>
                    <div class="p-4 flex flex-col flex-grow">
                        <p class="text-xs font-semibold text-gray-500">${item.category || (isEvent ? '活動' : '地點')}</p>
                        <h3 class="font-bold text-lg mt-1">${name}</h3>
                        <p class="text-sm text-gray-500">${item.address || item.district}</p>
                        <div class="mt-3 pt-3 border-t border-gray-100 flex flex-wrap gap-1.5">${senses.map(s => `<span class="bg-gray-100 text-gray-700 text-xs font-medium px-2 py-1 rounded-full">${s}</span>`).join('')}</div>
                        <div class="mt-auto pt-4"><button class="view-details-btn w-full bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">${isEvent ? '查看活動' : '查看小店'}</button></div>
                    </div>
                 `;
                 
                 card.querySelector('.view-details-btn').addEventListener('click', () => openModal(item));
                 // Only add listener if button exists (i.e., user is logged in)
                 const addToTripBtn = card.querySelector('.add-to-trip-btn');
                 if (addToTripBtn) {
                     addToTripBtn.addEventListener('click', (e) => {
                         e.stopPropagation(); 
                         handleAddToTrip(item);
                     });
                 }
                 resultsGrid.appendChild(card);
             });
        }

        function generateEventDetailsHtml(item) { /* ... same as index.html ... */ }        
        function openModal(item) { /* ... same modal generation logic ... */ }
        function closeModal() { /* ... same ... */ }

        // --- EVENT LISTENERS ---
        if(db && auth) { // Only add listeners if Firebase is ready
            districtSelect.addEventListener('change', performSearch);
            searchInput.addEventListener('input', performSearch);
            resultFilterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    resultFilterButtons.forEach(btn => btn.classList.remove('active', 'bg-gray-200'));
                    button.classList.add('active');
                    currentFilter = button.dataset.filter;
                    performSearch();
                });
            });
            modalBackdrop.addEventListener('click', e => { if (e.target === modalBackdrop) closeModal(); });
            tabButtons.forEach(button => {
                button.addEventListener('click', () => showPage(button.dataset.page));
            });
        }

        // --- INITIALIZATION ---
        if (db && auth) {
            populateSenses();
            fetchData();
            showPage('explore-page'); // Start on explore page
        } else {
             console.log("Firebase not ready, skipping initial data load and UI setup.");
             // Show a basic state or error if preferred
             loader.style.display = 'none';
        }

    </script>
</body>
</html>

